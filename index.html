<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contemporâneo Centro Educacional - Sistema</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- IMPORTANTE: Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        school: { green: '#047857', lightGreen: '#10B981', red: '#DC2626', bg: '#F3F4F6' }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #F3F4F6; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; }
        .status-online { background-color: #10B981; box-shadow: 0 0 5px #10B981; }
        
        @media print {
            body * { visibility: hidden; }
            #modal-report, #modal-report * { visibility: visible; }
            #modal-report { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; z-index: 9999; padding: 0; }
            #modal-report-content { box-shadow: none; max-width: 100%; padding: 20px; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- SETUP SCREEN -->
    <div id="setup-screen" class="fixed inset-0 z-[60] flex items-center justify-center bg-gray-900 text-white hidden">
        <div class="bg-gray-800 p-8 rounded-lg max-w-lg w-full text-center">
            <h2 class="text-2xl font-bold mb-4 text-yellow-400">Configuração Necessária</h2>
            <div class="bg-gray-900 p-4 rounded text-left text-xs font-mono mb-4 text-green-400">
                const firebaseConfig = { ... }
            </div>
            <button onclick="location.reload()" class="bg-blue-600 px-6 py-2 rounded hover:bg-blue-500">Já configurei</button>
        </div>
    </div>

    <!-- LOGIN -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-school-green">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md mx-4 fade-in relative">
            <div class="text-center mb-6">
                <i class="fas fa-school text-5xl text-school-green mb-3"></i>
                <h1 class="text-xl font-bold text-gray-800 leading-tight">CONTEMPORÂNEO<br>CENTRO EDUCACIONAL</h1>
                <p class="text-gray-500 text-sm mt-2">Sistema de Gestão Acadêmica</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Usuário</label>
                    <input type="text" id="username" class="block w-full border border-gray-300 rounded p-2 focus:ring-2 focus:ring-school-green outline-none" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Senha</label>
                    <input type="password" id="password" class="block w-full border border-gray-300 rounded p-2 focus:ring-2 focus:ring-school-green outline-none" required>
                </div>
                <div id="login-error" class="text-red-600 text-sm hidden bg-red-50 p-2 rounded border border-red-200 text-center">
                    <i class="fas fa-exclamation-circle"></i> Usuário ou senha incorretos.
                </div>
                <button type="submit" id="btn-login" class="w-full py-2.5 bg-school-green text-white rounded hover:bg-green-700 font-bold transition shadow-lg flex justify-center items-center gap-2">
                    <span>Acessar Sistema</span>
                </button>
            </form>
            <div class="mt-4 text-center text-xs text-gray-400">
                Acesso restrito a professores e coordenação.
            </div>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="app-screen" class="hidden flex-col h-full relative">
        <div id="loading-overlay" class="absolute inset-0 bg-white bg-opacity-80 z-40 flex items-center justify-center hidden">
            <i class="fas fa-circle-notch fa-spin text-4xl text-school-green"></i>
        </div>

        <!-- Header -->
        <header class="bg-school-green text-white shadow-md z-20 shrink-0">
            <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i class="fas fa-graduation-cap text-2xl"></i>
                    <div class="leading-tight">
                        <h1 class="text-sm font-bold tracking-wide uppercase">Contemporâneo Centro Educacional</h1>
                        <span class="text-xs text-green-200 block" id="user-display-name">Carregando...</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <!-- Botão Admin - Só aparece para o admin -->
                    <button onclick="openUsersModal()" id="btn-manage-users" class="hidden bg-green-800 hover:bg-green-900 text-white px-3 py-1.5 rounded text-xs font-bold items-center gap-2 transition border border-green-700">
                        <i class="fas fa-users-cog"></i> <span class="hidden sm:inline">Gerenciar Professores</span>
                    </button>

                    <div class="hidden md:flex bg-green-800 rounded p-1">
                        <button onclick="switchMode('grades')" id="nav-grades" class="px-4 py-1 rounded text-sm font-bold bg-white text-school-green shadow">Notas</button>
                        <button onclick="switchMode('attendance')" id="nav-attendance" class="px-4 py-1 rounded text-sm font-bold text-green-100 hover:text-white">Frequência</button>
                    </div>
                    <button onclick="logout()" class="text-white hover:text-red-200 ml-2" title="Sair"><i class="fas fa-sign-out-alt fa-lg"></i></button>
                </div>
            </div>
        </header>

        <!-- Barra de Controle -->
        <div class="bg-white border-b border-gray-200 shadow-sm shrink-0 z-10">
            <div class="max-w-7xl mx-auto px-4 py-3 flex flex-col md:flex-row gap-4 justify-between items-center">
                <div class="flex flex-wrap items-center gap-3 w-full md:w-auto justify-center md:justify-start">
                    
                    <!-- Seletor de Matéria (Bloqueado para professores comuns) -->
                    <div class="relative">
                        <select id="subject-select" onchange="changeSubject(this.value)" class="appearance-none bg-green-50 border border-green-200 text-green-800 font-bold py-2 pl-3 pr-8 rounded focus:outline-none cursor-pointer disabled:opacity-75 disabled:cursor-not-allowed disabled:bg-gray-100 disabled:text-gray-500">
                            <!-- Options via JS -->
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-green-800">
                            <i class="fas fa-chevron-down text-xs"></i>
                        </div>
                    </div>

                    <div class="h-6 w-px bg-gray-300 hidden md:block"></div>

                    <div class="flex space-x-1 overflow-x-auto" id="class-tabs"></div>
                </div>
                <div id="action-buttons" class="flex gap-2"></div>
            </div>
            <!-- Mobile Nav -->
            <div class="md:hidden flex justify-around bg-green-50 border-t border-gray-200 p-2 text-xs font-bold">
                <button onclick="switchMode('grades')" id="mob-grades" class="flex-1 text-center py-1 text-school-green border-b-2 border-school-green">NOTAS</button>
                <button onclick="switchMode('attendance')" id="mob-attendance" class="flex-1 text-center py-1 text-gray-500">CHAMADA</button>
            </div>
        </div>

        <!-- Conteúdo -->
        <main class="flex-1 overflow-auto bg-gray-50 p-2 md:p-6" id="main-content">
            <!-- Tabela Notas -->
            <div id="view-grades" class="max-w-7xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden fade-in border border-gray-200">
                <div class="bg-gray-50 px-4 py-2 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-sm font-bold text-gray-600 uppercase" id="table-header-title">Boletim</h2>
                    <span class="text-xs text-green-600 font-bold flex items-center gap-1"><i class="fas fa-sync-alt"></i> Sincronizado</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100 text-gray-500 font-bold text-xs uppercase text-center sticky top-0 z-10">
                            <tr>
                                <th class="px-4 py-3 text-left w-64 sticky left-0 bg-gray-100 shadow-sm border-r">Aluno</th>
                                <th class="w-16">U1</th><th class="w-16">U2</th><th class="w-16">U3</th><th class="w-16">U4</th><th class="w-16">U5</th><th class="w-16">U6</th>
                                <th class="w-20 bg-blue-50 text-blue-700 border-l">Faltas</th>
                                <th class="w-20 bg-gray-50 text-gray-800 border-l">Média</th>
                                <th class="w-24 text-red-600 border-l">Recup.</th>
                                <th class="w-32 border-l">Status</th>
                                <th class="w-20 border-l">...</th>
                            </tr>
                        </thead>
                        <tbody id="grades-body" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                    </table>
                </div>
                <div id="empty-state-grades" class="hidden p-12 text-center text-gray-500"><i class="fas fa-cloud-upload-alt text-4xl mb-3 text-gray-300"></i><p>Nenhum aluno nesta turma.</p></div>
            </div>

            <!-- Tabela Chamada -->
            <div id="view-attendance" class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden hidden fade-in border border-gray-200">
                <div class="p-5 border-b bg-gray-50 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="bg-white p-2 rounded border border-gray-200 shadow-sm">
                        <label class="block text-[10px] text-gray-500 font-bold uppercase mb-1">Data</label>
                        <input type="date" id="attendance-date" class="block w-full text-sm font-bold text-gray-800 focus:outline-none">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <tbody id="attendance-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div class="p-4 bg-gray-50 border-t flex justify-end">
                    <button onclick="saveDailyAttendance()" class="bg-school-green hover:bg-green-700 text-white px-8 py-2.5 rounded shadow-sm font-bold transition flex items-center gap-2">
                        <i class="fas fa-save"></i> Confirmar Chamada
                    </button>
                </div>
                <div id="empty-state-attendance" class="hidden p-10 text-center text-gray-500">Sem alunos.</div>
            </div>
        </main>
    </div>

    <!-- MODAL: GERENCIAR PROFESSORES (SÓ ADMIN) -->
    <div id="modal-users" class="fixed inset-0 bg-black bg-opacity-70 hidden z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh]">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h3 class="font-bold text-gray-800"><i class="fas fa-users-cog"></i> Gerenciar Professores</h3>
                <button onclick="document.getElementById('modal-users').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-4 overflow-y-auto">
                <!-- Form Novo Professor -->
                <div class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-100">
                    <h4 class="text-xs font-bold text-blue-800 uppercase mb-3">Cadastrar Novo Professor</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                        <input type="text" id="new-user-name" placeholder="Nome (ex: Prof. João)" class="border p-2 rounded text-sm">
                        <input type="text" id="new-user-login" placeholder="Usuário de Login" class="border p-2 rounded text-sm">
                        <input type="text" id="new-user-pass" placeholder="Senha de Acesso" class="border p-2 rounded text-sm">
                        <select id="new-user-subject" class="border p-2 rounded text-sm bg-white"></select>
                    </div>
                    <button onclick="createUser()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded text-sm font-bold transition">Criar Login</button>
                </div>

                <!-- Lista de Professores -->
                <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Professores Cadastrados</h4>
                <div id="users-list" class="space-y-2">
                    <!-- Lista via JS -->
                    <div class="text-center text-gray-400 text-sm py-4">Carregando...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Outros Modais (Aluno, Histórico, Relatório) -->
    <div id="modal-add" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded p-6 w-full max-w-sm">
            <h3 class="font-bold text-lg mb-4">Novo Aluno <span id="modal-class-name" class="text-school-green"></span></h3>
            <input type="text" id="new-name" class="w-full border p-2 rounded mb-4" placeholder="Nome Completo">
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-add')" class="px-4 py-2 bg-gray-100 rounded">Cancelar</button>
                <button onclick="addStudent()" class="px-4 py-2 bg-school-green text-white rounded">Salvar</button>
            </div>
        </div>
    </div>

    <div id="modal-history" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded shadow-xl w-full max-w-md max-h-[80vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="font-bold">Histórico de Faltas</h3>
                <button onclick="closeModal('modal-history')"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 overflow-y-auto flex-1"><ul id="history-list" class="space-y-2"></ul></div>
        </div>
    </div>

    <div id="modal-report" class="fixed inset-0 bg-black bg-opacity-70 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm overflow-y-auto">
        <div id="modal-report-content" class="bg-white rounded-lg shadow-2xl w-full max-w-2xl flex flex-col">
            <div class="p-6 border-b border-gray-200 flex justify-between items-start bg-gray-50 rounded-t-lg">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 bg-school-green text-white rounded-full flex items-center justify-center text-2xl font-bold" id="report-avatar">--</div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800" id="report-name">--</h2>
                        <p class="text-gray-500">Turma: <span id="report-class" class="font-bold">--</span> | Disciplina: <span id="report-subject" class="font-bold">--</span></p>
                        <p class="text-xs text-gray-400 mt-1">CONTEMPORÂNEO CENTRO EDUCACIONAL</p>
                    </div>
                </div>
                <button onclick="closeModal('modal-report')" class="text-gray-400 hover:text-red-500 no-print"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="p-6 flex-1 overflow-y-auto">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg text-center border border-blue-100">
                        <span class="block text-xs font-bold text-blue-500 uppercase">Média Final</span>
                        <span class="text-2xl font-bold text-blue-800" id="report-avg">--</span>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg text-center border border-green-100">
                        <span class="block text-xs font-bold text-green-500 uppercase">Faltas</span>
                        <span class="text-2xl font-bold text-green-800" id="report-faults">--</span>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg text-center border border-gray-200">
                        <span class="block text-xs font-bold text-gray-500 uppercase">Status</span>
                        <span class="text-xl font-bold text-gray-800" id="report-status">--</span>
                    </div>
                </div>
                <h4 class="font-bold text-gray-700 mb-2 border-b pb-1">Desempenho por Unidade</h4>
                <div class="flex justify-between mb-6 bg-gray-50 p-3 rounded text-sm">
                    <div class="text-center"><span class="block text-xs text-gray-500">U1</span><strong id="rep-u1">-</strong></div>
                    <div class="text-center"><span class="block text-xs text-gray-500">U2</span><strong id="rep-u2">-</strong></div>
                    <div class="text-center"><span class="block text-xs text-gray-500">U3</span><strong id="rep-u3">-</strong></div>
                    <div class="text-center"><span class="block text-xs text-gray-500">U4</span><strong id="rep-u4">-</strong></div>
                    <div class="text-center"><span class="block text-xs text-gray-500">U5</span><strong id="rep-u5">-</strong></div>
                    <div class="text-center"><span class="block text-xs text-gray-500">U6</span><strong id="rep-u6">-</strong></div>
                    <div class="text-center border-l pl-2"><span class="block text-xs text-red-500">Rec</span><strong id="rep-rec" class="text-red-600">-</strong></div>
                </div>
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-gray-700">Observações Pedagógicas</h4>
                        <button onclick="generateAIReport()" id="btn-ai-generate" class="no-print bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-xs font-bold shadow flex items-center gap-1 transition">
                            <i class="fas fa-magic"></i> Gerar com IA
                        </button>
                    </div>
                    
                    <!-- Container de Chave de API melhorado -->
                    <div id="ai-key-container" class="mb-3 hidden no-print bg-purple-50 p-3 rounded-lg border border-purple-100 shadow-sm">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-xs font-bold text-purple-800"><i class="fas fa-key"></i> Chave de API Google (Gemini)</p>
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-[10px] text-blue-600 hover:underline">Obter chave grátis</a>
                        </div>
                        <div class="flex gap-2">
                            <input type="password" id="gemini-api-key" class="w-full border p-1.5 text-sm rounded focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Cole sua chave aqui (começa com AIza...)">
                            <button onclick="saveApiKey()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-1 rounded text-xs font-bold transition">Salvar</button>
                        </div>
                        <p class="text-[10px] text-gray-500 mt-1">Sua chave é salva apenas no seu navegador.</p>
                    </div>

                    <!-- Botão para redefinir chave se necessário -->
                    <div id="ai-reset-container" class="hidden text-right mb-1">
                        <button onclick="resetApiKey()" class="text-[10px] text-gray-400 hover:text-red-500 underline">Alterar Chave API</button>
                    </div>

                    <textarea id="report-observation" rows="6" class="w-full border border-gray-300 rounded p-3 text-sm focus:ring-2 focus:ring-school-green outline-none" placeholder="As observações aparecerão aqui..."></textarea>
                    <div id="ai-loading" class="hidden text-center py-2 text-purple-600 text-xs font-bold"><i class="fas fa-spinner fa-spin"></i> Analisando dados e escrevendo relatório...</div>
                </div>
            </div>
            <div class="p-4 bg-gray-50 rounded-b-lg flex justify-end gap-3 border-t no-print">
                <button onclick="window.print()" class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded font-bold flex items-center gap-2"><i class="fas fa-print"></i> Imprimir</button>
            </div>
        </div>
    </div>

    <script>
        // =========================================================================
        // KELVIN, SUA CONFIGURAÇÃO
        // =========================================================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyCBZGHO9APpiZ-8Mgq3TDErFvKW62nnqH0",
            authDomain: "concenal-sistema.firebaseapp.com",
            projectId: "concenal-sistema",
            storageBucket: "concenal-sistema.firebasestorage.app",
            messagingSenderId: "825709353374",
            appId: "1:825709353374:web:1dd2657f60fb50b46c5e8f"
        };

        // =========================================================================

        let db;
        let unsubscribe = null;
        let currentStudentForReport = null;
        let currentUser = null; 

        const today = new Date().toISOString().split('T')[0];
        const SUBJECTS = ["Matemática", "Português", "Geografia", "História", "Arte", "Educação Física", "Inglês", "Ciências"];
        
        let appData = {
            currentClass: "9A",
            currentSubject: "Matemática",
            currentMode: "grades",
            classes: ["6A", "6B", "7A", "7B", "8A", "8B", "9A", "9B"],
            students: [] 
        };

        function init() {
            if (!firebaseConfig.apiKey) {
                document.getElementById('setup-screen').classList.remove('hidden');
                return;
            }

            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            db.enablePersistence().catch(err => console.log("Persistência offline desativada/erro", err));

            const session = localStorage.getItem('contemporaneo_session');
            if(session) {
                currentUser = JSON.parse(session);
                showApp();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }

            document.getElementById('attendance-date').value = today;
            populateSubjectSelect();
            populateNewUserSubjectSelect(); 
        }

        // --- LOGIN ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            const btn = document.getElementById('btn-login');
            const err = document.getElementById('login-error');

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';
            btn.disabled = true;
            err.classList.add('hidden');

            try {
                if (u === "admin" && p === "1234") {
                    currentUser = { name: "Coordenação / Master", role: "admin", subject: "all" };
                    finalizeLogin();
                    return;
                }

                const snapshot = await db.collection('concenal_users')
                    .where('username', '==', u)
                    .where('password', '==', p)
                    .limit(1)
                    .get();

                if (!snapshot.empty) {
                    const doc = snapshot.docs[0].data();
                    currentUser = { 
                        name: doc.name, 
                        role: "teacher", 
                        subject: doc.subject 
                    };
                    finalizeLogin();
                } else {
                    throw new Error("Credenciais inválidas");
                }

            } catch (error) {
                err.classList.remove('hidden');
                btn.innerHTML = 'Acessar Sistema';
                btn.disabled = false;
            }
        });

        function finalizeLogin() {
            localStorage.setItem('contemporaneo_session', JSON.stringify(currentUser));
            showApp();
        }

        function logout() {
            localStorage.removeItem('contemporaneo_session');
            location.reload();
        }

        // --- UI ---
        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            
            document.getElementById('user-display-name').innerText = currentUser.name;
            const subSelect = document.getElementById('subject-select');
            const btnManage = document.getElementById('btn-manage-users');

            if (currentUser.role === 'admin') {
                subSelect.disabled = false;
                btnManage.classList.remove('hidden');
                btnManage.classList.add('flex'); 
            } else {
                appData.currentSubject = currentUser.subject;
                subSelect.value = currentUser.subject;
                subSelect.disabled = true; 
                btnManage.classList.add('hidden');
            }

            if (!subSelect.disabled) subSelect.value = appData.currentSubject;
            startRealtimeSync();
        }

        function openUsersModal() {
            document.getElementById('modal-users').classList.remove('hidden');
            loadUsersList();
        }

        async function createUser() {
            const name = document.getElementById('new-user-name').value;
            const user = document.getElementById('new-user-login').value;
            const pass = document.getElementById('new-user-pass').value;
            const subj = document.getElementById('new-user-subject').value;

            if (!name || !user || !pass) return alert("Preencha todos os campos!");

            try {
                await db.collection('concenal_users').add({
                    name: name,
                    username: user,
                    password: pass,
                    subject: subj,
                    createdAt: new Date()
                });
                alert("Professor criado com sucesso!");
                document.getElementById('new-user-name').value = "";
                document.getElementById('new-user-login').value = "";
                document.getElementById('new-user-pass').value = "";
                loadUsersList();
            } catch (e) {
                console.error(e);
                alert("Erro ao criar usuário.");
            }
        }

        function loadUsersList() {
            const listDiv = document.getElementById('users-list');
            listDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>';

            db.collection('concenal_users').orderBy('name').get().then(snap => {
                if(snap.empty) {
                    listDiv.innerHTML = '<div class="text-center text-gray-400">Nenhum professor cadastrado ainda.</div>';
                    return;
                }
                
                listDiv.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const el = document.createElement('div');
                    el.className = "flex justify-between items-center bg-gray-50 p-3 rounded border border-gray-200";
                    el.innerHTML = `
                        <div>
                            <div class="font-bold text-gray-800">${d.name}</div>
                            <div class="text-xs text-gray-500">Login: <strong>${d.username}</strong> | Matéria: <span class="text-blue-600 font-bold">${d.subject}</span></div>
                        </div>
                        <button onclick="deleteUser('${doc.id}')" class="text-red-400 hover:text-red-600 px-2"><i class="fas fa-trash"></i></button>
                    `;
                    listDiv.appendChild(el);
                });
            });
        }

        async function deleteUser(id) {
            if(confirm("Tem certeza que deseja remover este professor? Ele perderá o acesso.")) {
                await db.collection('concenal_users').doc(id).delete();
                loadUsersList();
            }
        }

        // --- CORE LOGIC ---
        function startRealtimeSync() {
            document.getElementById('loading-overlay').classList.remove('hidden');
            unsubscribe = db.collection('concenal_students').onSnapshot((snapshot) => {
                const students = [];
                snapshot.forEach((doc) => {
                    students.push({ id: doc.id, ...doc.data() });
                });
                appData.students = students;
                updateUI();
                document.getElementById('loading-overlay').classList.add('hidden');
            }, (error) => {
                console.error("Erro ao sincronizar:", error);
            });
        }

        function updateUI() {
            renderClassTabs();
            if (appData.currentMode === 'grades') renderGradesTable();
            else renderAttendanceTable();
        }

        // --- CRUD ALUNOS ---
        async function saveStudentToCloud(student) {
            try { const { id, ...data } = student; await db.collection('concenal_students').doc(id).set(data, { merge: true }); } 
            catch (error) { console.error("Erro ao salvar:", error); }
        }
        async function addStudentToCloud(name, className) {
            await db.collection('concenal_students').add({ name, class: className, subjects: {} });
        }
        async function deleteStudentFromCloud(id) {
            if(confirm("Apagar aluno?")) await db.collection('concenal_students').doc(id).delete();
        }

        function updateGrade(id, idx, val) {
            const s = appData.students.find(st => st.id === id);
            if(s) {
                const subData = ensureSubjectData(s, appData.currentSubject);
                subData.units[idx] = val === "" ? null : parseFloat(val);
                saveStudentToCloud(s);
            }
        }

        function updateRecovery(id, val) {
            const s = appData.students.find(st => st.id === id);
            if(s) {
                const subData = ensureSubjectData(s, appData.currentSubject);
                subData.recovery = val === "" ? null : parseFloat(val);
                saveStudentToCloud(s);
            }
        }

        function addStudent() {
            const name = document.getElementById('new-name').value;
            if (name) {
                addStudentToCloud(name, appData.currentClass);
                closeModal('modal-add');
                document.getElementById('new-name').value = '';
            }
        }

        function saveDailyAttendance() {
            const date = document.getElementById('attendance-date').value;
            let batch = db.batch();
            let hasChanges = false;
            appData.students.forEach(s => {
                if (s.class === appData.currentClass && tempAttendance[s.id]) {
                    const subData = ensureSubjectData(s, appData.currentSubject);
                    subData.attendance[date] = tempAttendance[s.id];
                    const docRef = db.collection('concenal_students').doc(s.id);
                    let updateData = {};
                    updateData[`subjects.${appData.currentSubject}.attendance`] = subData.attendance;
                    batch.update(docRef, updateData);
                    hasChanges = true;
                }
            });
            if (hasChanges) {
                batch.commit().then(() => { alert("Chamada salva!"); renderAttendanceTable(); });
            }
        }

        function ensureSubjectData(student, subjectName) {
            if (!student.subjects) student.subjects = {};
            if (!student.subjects[subjectName]) student.subjects[subjectName] = { units: [null,null,null,null,null,null], recovery: null, attendance: {} };
            return student.subjects[subjectName];
        }

        function populateSubjectSelect() {
            const select = document.getElementById('subject-select');
            select.innerHTML = SUBJECTS.map(sub => `<option value="${sub}">${sub}</option>`).join('');
            select.value = appData.currentSubject;
        }

        function populateNewUserSubjectSelect() {
            const select = document.getElementById('new-user-subject');
            select.innerHTML = SUBJECTS.map(sub => `<option value="${sub}">${sub}</option>`).join('');
        }

        function switchMode(mode) { appData.currentMode = mode; updateUI(); }
        
        function changeSubject(val) {
            if (currentUser.role !== 'admin') return; 
            appData.currentSubject = val;
            updateUI();
        }

        function renderClassTabs() {
            const container = document.getElementById('class-tabs');
            container.innerHTML = '';
            appData.classes.forEach(cls => {
                const isActive = cls === appData.currentClass;
                const btn = document.createElement('button');
                btn.className = `px-3 py-2 rounded text-sm font-bold whitespace-nowrap ${isActive ? 'bg-school-green text-white shadow' : 'bg-white text-gray-500 border'}`;
                btn.innerText = cls;
                btn.onclick = () => { appData.currentClass = cls; updateUI(); };
                container.appendChild(btn);
            });
        }

        function getStudentsByClass() {
            if(!appData.students) return [];
            return appData.students.filter(s => s.class === appData.currentClass).sort((a,b) => a.name.localeCompare(b.name));
        }

        function renderGradesTable() {
            const tbody = document.getElementById('grades-body');
            tbody.innerHTML = '';
            document.getElementById('table-header-title').innerText = `Boletim: ${appData.currentSubject}`;
            document.getElementById('view-grades').classList.remove('hidden');
            document.getElementById('view-attendance').classList.add('hidden');
            document.getElementById('action-buttons').innerHTML = `<button onclick="openAddModal()" class="bg-school-green text-white px-3 py-2 rounded text-sm font-bold shadow"><i class="fas fa-plus"></i> Aluno</button>`;

            const students = getStudentsByClass();
            if (students.length === 0) {
                document.getElementById('empty-state-grades').classList.remove('hidden');
                return;
            }
            document.getElementById('empty-state-grades').classList.add('hidden');

            students.forEach(s => {
                const subData = ensureSubjectData(s, appData.currentSubject);
                const calc = calculateStatus(subData);
                const totalFaults = Object.values(subData.attendance || {}).filter(st => st === 'F').length;
                let unitsHtml = '';
                for (let i = 0; i < 6; i++) {
                    const val = subData.units[i] ?? '';
                    const color = (val !== '' && val < 6) ? 'text-red-600 font-bold' : (val !== '' ? 'text-green-700' : 'text-gray-400');
                    unitsHtml += `<td class="px-1 py-2 border-l"><input type="number" step="0.1" class="w-full text-center bg-transparent focus:outline-none ${color}" value="${val}" onchange="updateGrade('${s.id}', ${i}, this.value)"></td>`;
                }

                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 transition";
                tr.innerHTML = `
                    <td class="px-4 py-3 font-medium text-gray-900 border-r flex justify-between items-center group">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <span class="truncate">${s.name}</span>
                        </div>
                        <div class="flex items-center opacity-0 group-hover:opacity-100 transition">
                            <button onclick="openReportModal('${s.id}')" class="text-gray-400 hover:text-blue-600 mr-2"><i class="fas fa-file-alt"></i></button>
                            <button onclick="deleteStudentFromCloud('${s.id}')" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                    ${unitsHtml}
                    <td class="px-1 py-2 bg-blue-50 text-center font-bold text-blue-800 border-l cursor-pointer" onclick="showHistory('${s.id}')">${totalFaults}</td>
                    <td class="px-2 py-3 text-center font-bold bg-gray-50 border-l ${parseFloat(calc.average) < 6 ? 'text-red-600' : 'text-gray-700'}">${calc.average}</td>
                    <td class="px-1 py-2 text-center border-l"><input type="number" step="0.1" class="w-full text-center ${calc.average >= 6 ? 'bg-gray-100' : 'bg-red-50 text-red-700'}" value="${subData.recovery ?? ''}" ${calc.average >= 6 ? 'disabled' : ''} onchange="updateRecovery('${s.id}', this.value)"></td>
                    <td class="px-2 py-3 text-center text-[10px] font-bold uppercase border-l ${calc.statusClass}">${calc.status}</td>
                    <td class="px-2 py-3 text-center text-xs border-l"><button onclick="showHistory('${s.id}')" class="text-gray-400"><i class="fas fa-list-alt"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderAttendanceTable() {
            const tbody = document.getElementById('attendance-body');
            tbody.innerHTML = '';
            document.getElementById('view-grades').classList.add('hidden');
            document.getElementById('view-attendance').classList.remove('hidden');
            document.getElementById('action-buttons').innerHTML = '';
            const students = getStudentsByClass();
            const date = document.getElementById('attendance-date').value;
            tempAttendance = {};
            if (students.length === 0) {
                document.getElementById('empty-state-attendance').classList.remove('hidden');
                return;
            }
            document.getElementById('empty-state-attendance').classList.add('hidden');
            students.forEach(s => {
                const subData = ensureSubjectData(s, appData.currentSubject);
                const isPresent = subData.attendance[date] !== 'F';
                tempAttendance[s.id] = isPresent ? 'P' : 'F';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 font-bold text-gray-700">${s.name}</td>
                    <td class="px-6 py-4 text-center">
                        <button id="btn-att-${s.id}" onclick="toggleAttendance('${s.id}')" class="w-32 py-2 rounded shadow text-xs font-bold transition ${isPresent ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${isPresent ? 'PRESENTE' : 'FALTOU'}</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('attendance-date').onchange = renderAttendanceTable;
        }

        function toggleAttendance(id) {
            tempAttendance[id] = tempAttendance[id] === 'P' ? 'F' : 'P';
            const btn = document.getElementById(`btn-att-${id}`);
            const isP = tempAttendance[id] === 'P';
            btn.className = `w-32 py-2 rounded shadow text-xs font-bold transition ${isP ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            btn.innerText = isP ? 'PRESENTE' : 'FALTOU';
        }

        function calculateStatus(subData) {
            let sum = 0;
            subData.units.forEach(u => { if (u !== null && u !== "") sum += parseFloat(u); });
            let avg = sum / 6;
            let status = "Cursando", statusClass = "text-gray-500", final = avg;
            if (avg < 6.0) {
                if (subData.recovery !== null && subData.recovery !== "") {
                    final = (avg + parseFloat(subData.recovery)) / 2;
                    status = final >= 6.0 ? "Aprovado (Rec)" : "Reprovado";
                    statusClass = final >= 6.0 ? "text-green-600" : "text-red-600";
                } else { status = "Recuperação"; statusClass = "text-orange-500"; }
            } else { status = "Aprovado"; statusClass = "text-green-600"; }
            return { average: avg.toFixed(1), status, statusClass };
        }

        // --- RELATÓRIO IA ATUALIZADO (Tratamento de Erros e Lista de Modelos) ---
        function openReportModal(studentId) {
            const s = appData.students.find(st => st.id === studentId);
            if (!s) return;
            currentStudentForReport = s;
            const subData = ensureSubjectData(s, appData.currentSubject);
            const calc = calculateStatus(subData);
            const totalFaults = Object.values(subData.attendance || {}).filter(st => st === 'F').length;

            document.getElementById('report-name').innerText = s.name;
            document.getElementById('report-avatar').innerText = getInitials(s.name);
            document.getElementById('report-class').innerText = s.class;
            document.getElementById('report-subject').innerText = appData.currentSubject;
            document.getElementById('report-avg').innerText = calc.average;
            document.getElementById('report-faults').innerText = totalFaults;
            document.getElementById('report-status').innerText = calc.status;

            for(let i=0; i<6; i++) { document.getElementById(`rep-u${i+1}`).innerText = subData.units[i] !== null ? subData.units[i] : '-'; }
            document.getElementById('rep-rec').innerText = subData.recovery !== null ? subData.recovery : '-';
            document.getElementById('report-observation').value = ""; 
            
            // Lógica de mostrar/esconder chave
            if (localStorage.getItem('gemini_api_key')) {
                document.getElementById('ai-key-container').classList.add('hidden');
                document.getElementById('ai-reset-container').classList.remove('hidden');
            } else {
                document.getElementById('ai-key-container').classList.remove('hidden');
                document.getElementById('ai-reset-container').classList.add('hidden');
            }
            
            document.getElementById('modal-report').classList.remove('hidden');
        }

        async function generateAIReport() {
            const apiKey = localStorage.getItem('gemini_api_key');
            if (!apiKey) { document.getElementById('ai-key-container').classList.remove('hidden'); alert("Insira sua API Key para continuar."); return; }
            
            const s = currentStudentForReport;
            const subData = ensureSubjectData(s, appData.currentSubject);
            const calc = calculateStatus(subData);
            const faults = Object.values(subData.attendance || {}).filter(st => st === 'F').length;
            const gradesStr = subData.units.map((u, i) => `U${i+1}: ${u ?? 'N/A'}`).join(', ');

            const prompt = `Atue como um coordenador pedagógico. Escreva um relatório curto sobre o aluno ${s.name}, disciplina ${appData.currentSubject}. Dados: Notas [${gradesStr}], Média: ${calc.average}, Faltas: ${faults}, Status: ${calc.status}. Seja construtivo e profissional.`;

            document.getElementById('ai-loading').classList.remove('hidden');
            document.getElementById('report-observation').value = "Gerando relatório inteligente...";
            
            // Lista ampliada de modelos para tentar (mais robusto)
            const models = ['gemini-1.5-flash', 'gemini-1.5-flash-001', 'gemini-1.5-flash-002', 'gemini-1.5-pro', 'gemini-1.5-pro-001', 'gemini-pro'];
            let lastError = "";
            let success = false;

            for (const model of models) {
                try {
                    console.log(`Tentando modelo: ${model}`);
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ 
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        // Captura erro HTTP real (400, 403, 429)
                        throw new Error(data.error?.message || `Erro HTTP ${response.status}`);
                    }

                    if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                        document.getElementById('report-observation').value = data.candidates[0].content.parts[0].text;
                        success = true;
                        break; 
                    }
                } catch (error) {
                    lastError = error.message;
                    console.error(`Falha no modelo ${model}:`, error);
                }
            }

            document.getElementById('ai-loading').classList.add('hidden');

            if (!success) {
                console.error("Erro final:", lastError);
                let msg = "Falha na geração automática.";
                
                // Diagnóstico amigável
                if (lastError.includes("400") || lastError.includes("API key")) {
                    msg = "Erro de Autenticação: Sua Chave API parece inválida. Por favor, insira novamente.";
                    resetApiKey(); // Abre o campo automaticamente
                } else if (lastError.includes("429") || lastError.includes("Quota")) {
                    msg = "Limite de uso da IA excedido (Cota Gratuita). Tente novamente mais tarde.";
                } else {
                    msg = `Erro técnico: ${lastError}`;
                }

                alert(msg);
                if(document.getElementById('report-observation').value.includes("Gerando")) {
                    document.getElementById('report-observation').value = msg + " Por favor, escreva manualmente.";
                }
            }
        }

        function saveApiKey() {
            const key = document.getElementById('gemini-api-key').value.trim();
            if (key) { 
                localStorage.setItem('gemini_api_key', key); 
                document.getElementById('ai-key-container').classList.add('hidden'); 
                document.getElementById('ai-reset-container').classList.remove('hidden');
                alert("Chave salva com sucesso!");
            }
        }

        function resetApiKey() {
            localStorage.removeItem('gemini_api_key');
            document.getElementById('gemini-api-key').value = "";
            document.getElementById('ai-key-container').classList.remove('hidden');
            document.getElementById('ai-reset-container').classList.add('hidden');
        }

        function showHistory(id) {
            const s = appData.students.find(st => st.id === id);
            if(!s) return;
            const subData = ensureSubjectData(s, appData.currentSubject);
            const faults = Object.entries(subData.attendance).filter(([d, st]) => st === 'F').sort();
            const list = document.getElementById('history-list');
            list.innerHTML = faults.length ? '' : '<li class="text-center text-gray-400">Sem faltas.</li>';
            faults.forEach(([d]) => { list.innerHTML += `<li class="bg-red-50 p-2 rounded flex justify-between font-bold text-red-700"><span>${d.split('-').reverse().join('/')}</span><span>Falta</span></li>`; });
            document.getElementById('modal-history').classList.remove('hidden');
        }

        function openAddModal() { document.getElementById('modal-class-name').innerText = appData.currentClass; document.getElementById('modal-add').classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function getInitials(name) { return name.split(' ').map((n,i,a) => i===0 || i===a.length-1 ? n[0] : '').join('').toUpperCase(); }
        
        init();
    </script>
</body>
</html>

