<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIÁRIO ESCOLAR V29</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        school: { green: '#047857', lightGreen: '#10B981', red: '#DC2626', bg: '#F3F4F6' }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #F3F4F6; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .status-rf { color: #7f1d1d; font-weight: 800; background-color: #fee2e2; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; }
        .status-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 800; }
        .online-dot { width: 10px; height: 10px; background-color: #10B981; border-radius: 50%; display: inline-block; box-shadow: 0 0 5px #10B981; }
        .offline-dot { width: 10px; height: 10px; background-color: #9CA3AF; border-radius: 50%; display: inline-block; }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; background: white; z-index: 99999; }
            .no-print { display: none !important; }
        }

        .chat-msg { max-width: 85%; border-radius: 12px; margin-bottom: 8px; position: relative; }
        .chat-msg.sent { align-self: flex-end; background-color: #dcf8c6; border-bottom-right-radius: 0; border: 1px solid #c5e1a5; }
        .chat-msg.received { align-self: flex-start; background-color: #ffffff; border-bottom-left-radius: 0; border: 1px solid #e0e0e0; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scroll-x::-webkit-scrollbar { height: 0px; background: transparent; }
        .hide-scroll-x { scrollbar-width: none; }
    </style>
</head>
<body class="text-gray-800 min-h-screen flex flex-col bg-gray-50 overflow-x-hidden">

    <!-- ÁREA DE IMPRESSÃO PDF -->
    <div id="print-area" class="hidden font-serif bg-white p-8"></div>

    <!-- Container de Notificações Pop-up -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-[200] flex flex-col gap-2 pointer-events-none"></div>

    <!-- SETUP SCREEN -->
    <div id="setup-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-gray-900 text-white hidden">
        <div class="bg-gray-800 p-8 rounded-lg max-w-lg w-full text-center shadow-2xl">
            <h2 class="text-2xl font-bold mb-4 text-yellow-400">Iniciando Sistema</h2>
            <p class="text-sm mb-4 text-gray-300">Conectando ao servidor seguro...</p>
            <i class="fas fa-circle-notch fa-spin text-3xl text-school-lightGreen"></i>
            <div id="setup-error-log" class="text-xs text-red-400 mt-4 break-words"></div>
        </div>
    </div>

    <!-- LOGIN -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-school-green">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md mx-4 fade-in relative">
            <div class="text-center mb-6">
                <!-- Logo Concenal -->
                <img src="https://i.ibb.co/JWKSzsWy/colegio-concenal-2.webp" onerror="this.src='https://placehold.co/150x50/png?text=CONCENAL'" alt="CONCENAL" class="mx-auto mb-4 w-40 h-auto">
                <h1 class="text-xl font-bold text-gray-800 leading-tight uppercase font-serif">Diário Escolar</h1>
                <p class="text-gray-400 text-[10px] mt-2 uppercase tracking-widest font-bold border-t pt-2">Acesso Restrito - CONCENAL</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 ml-1">Usuário</label>
                    <input type="text" id="username" class="block w-full border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-school-green outline-none bg-gray-50 transition" placeholder="Digite seu login" required>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 ml-1">Senha</label>
                    <input type="password" id="password" class="block w-full border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-school-green outline-none bg-gray-50 transition" placeholder="Digite sua senha" required>
                </div>
                <div id="login-error" class="text-red-600 text-xs hidden bg-red-50 p-3 rounded-lg border border-red-100 text-center font-bold">
                    <i class="fas fa-exclamation-circle mr-1"></i> Credenciais inválidas.
                </div>
                <button type="submit" id="btn-login" class="w-full py-3 bg-school-green text-white rounded-lg hover:bg-green-700 font-bold transition shadow-lg flex justify-center items-center gap-2">
                    <span>Entrar no Sistema</span>
                </button>
            </form>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="app-screen" class="hidden flex-col min-h-screen relative">
        <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 z-50 flex items-center justify-center hidden">
            <div class="text-center">
                <i class="fas fa-circle-notch fa-spin text-5xl text-school-green"></i>
                <p class="mt-4 text-school-green font-bold uppercase text-[10px] tracking-widest">Processando...</p>
            </div>
        </div>

        <!-- Header -->
        <header class="bg-school-green text-white shadow-md z-30 sticky top-0">
            <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img src="https://i.ibb.co/JWKSzsWy/colegio-concenal-2.webp" onerror="this.src='https://placehold.co/150x50/png?text=CONCENAL'" alt="CONCENAL" class="h-10 bg-white p-1 rounded shadow-sm cursor-pointer" onclick="location.reload()">
                    <div class="leading-tight hidden sm:block border-l border-green-700 pl-3">
                        <h1 class="text-xs font-bold uppercase opacity-80">Diário Escolar</h1>
                        <span class="text-[10px] text-green-200 block truncate font-bold" id="user-display-name">...</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <button id="btn-notifications" onclick="openNotifications()" class="hidden relative bg-green-800 p-2 rounded-lg hover:bg-green-700 transition border border-green-700 shadow-sm" title="Notificações do Sistema">
                        <i class="fas fa-bell"></i>
                        <span id="notif-badge" class="absolute -top-1 -right-1 bg-orange-500 w-3 h-3 rounded-full hidden border border-white animate-pulse"></span>
                    </button>

                    <button id="btn-chat" onclick="openChat()" class="hidden relative bg-green-800 p-2 rounded-lg hover:bg-green-700 transition border border-green-700 shadow-sm" title="Comunicação Interna">
                        <i class="fas fa-comments"></i>
                        <span id="chat-badge" class="absolute -top-1 -right-1 bg-red-500 w-3 h-3 rounded-full hidden border border-white animate-pulse"></span>
                    </button>
                    
                    <button onclick="openCoordPanel()" id="btn-coord" class="hidden bg-white text-school-green px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase shadow-sm border border-white hover:bg-green-50 transition"><i class="fas fa-eye mr-1"></i> Coordenação</button>
                    <button onclick="openUsersModal()" id="btn-admin" class="hidden bg-orange-500 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase shadow-sm border border-orange-600 hover:bg-orange-600 transition"><i class="fas fa-users-cog mr-1"></i> Gestão</button>
                    <button onclick="openConfigModal()" id="btn-config" class="hidden bg-gray-700 bg-opacity-30 text-white border border-white border-opacity-20 px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase shadow-sm hover:bg-opacity-50 transition"><i class="fas fa-sliders-h mr-1"></i> Currículo</button>
                    
                    <button onclick="logout()" class="text-white hover:text-red-300 ml-2 p-2" title="Sair"><i class="fas fa-sign-out-alt fa-lg"></i></button>
                </div>
            </div>
        </header>

        <!-- Barra de Controle e Abas -->
        <div id="control-bar" class="bg-white border-b border-gray-200 shadow-sm z-20 sticky top-16">
            <div class="max-w-7xl mx-auto px-4 pt-3 flex flex-col md:flex-row gap-4 justify-between items-center border-b border-gray-50 pb-3">
                <div class="flex flex-wrap items-center gap-3 w-full md:w-auto">
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-tighter">Matéria</label>
                        <select id="subject-select" onchange="changeSubject(this.value)" class="bg-green-50 border border-green-200 text-school-green font-bold py-1.5 px-3 rounded-lg text-sm focus:ring-1 focus:ring-school-green outline-none cursor-pointer"></select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-tighter">Turma</label>
                        <select id="class-select" onchange="changeClass(this.value)" class="bg-gray-50 border border-gray-200 text-gray-800 font-bold py-1.5 px-3 rounded-lg text-sm focus:ring-1 focus:ring-school-green outline-none cursor-pointer"></select>
                    </div>
                    <div id="class-tabs" class="ml-2"></div>
                </div>
                <div id="action-buttons" class="flex gap-2"></div>
            </div>
            <!-- Abas (Tabs) -->
            <div class="max-w-7xl mx-auto px-4 flex gap-6 overflow-x-auto hide-scroll-x mt-1">
                <button onclick="switchMode('grades')" id="nav-grades" class="pb-2 pt-2 text-[11px] font-bold uppercase border-b-2 border-transparent text-gray-500 hover:text-school-green transition whitespace-nowrap">Notas e Médias</button>
                <button onclick="switchMode('attendance')" id="nav-attendance" class="pb-2 pt-2 text-[11px] font-bold uppercase border-b-2 border-transparent text-gray-500 hover:text-school-green transition whitespace-nowrap">Frequência</button>
                <button onclick="switchMode('daily')" id="nav-daily" class="pb-2 pt-2 text-[11px] font-bold uppercase border-b-2 border-transparent text-gray-500 hover:text-school-green transition whitespace-nowrap">Diário de Bordo</button>
                <button onclick="switchMode('activities')" id="nav-activities" class="pb-2 pt-2 text-[11px] font-bold uppercase border-b-2 border-transparent text-gray-500 hover:text-school-green transition whitespace-nowrap">Atividades e Materiais</button>
            </div>
        </div>

        <!-- Conteúdo Principal -->
        <main class="w-full max-w-7xl mx-auto p-2 md:p-6" id="main-content">
            
            <!-- Tabela de Notas -->
            <div id="view-grades" class="bg-white rounded-xl shadow-xl overflow-hidden fade-in border border-gray-200">
                <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Acompanhamento de Notas</h2>
                    <div id="read-only-msg" class="text-[10px] font-bold bg-orange-100 text-orange-700 px-2 py-1 rounded hidden">APENAS CONSULTA</div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-center">
                        <thead class="bg-gray-50 text-gray-400 font-bold text-[10px] uppercase">
                            <tr>
                                <th class="px-4 py-4 text-left w-56 sticky left-0 bg-gray-50 shadow-sm border-r z-10">Aluno</th>
                                <th class="w-14">U1</th><th class="w-14">U2</th><th class="w-14">U3</th><th class="w-14">U4</th><th class="w-14">U5</th><th class="w-14">U6</th>
                                <th class="w-24 bg-blue-50 text-blue-700 border-l">Faltas</th>
                                <th class="w-16 bg-gray-100 text-gray-600 border-l">Média</th>
                                <th class="w-20 text-red-600 border-l">Rec</th>
                                <th class="w-24 border-l">Status</th>
                            </tr>
                        </thead>
                        <tbody id="grades-body" class="bg-white divide-y divide-gray-100 text-sm"></tbody>
                    </table>
                </div>
                <div id="empty-state" class="hidden p-20 text-center text-gray-300">
                    <i class="fas fa-folder-open text-6xl mb-4"></i>
                    <p class="font-bold uppercase text-xs tracking-widest">Selecione uma Turma Válida</p>
                </div>
            </div>

            <!-- Tabela de Frequência -->
            <div id="view-attendance" class="max-w-4xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden hidden fade-in border border-gray-200">
                <div class="p-4 border-b bg-gray-50">
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex items-center gap-3">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-tighter">Data da Chamada:</label>
                            <input type="date" id="attendance-date" onchange="renderAttendanceTable()" class="border border-gray-200 rounded-lg p-2 text-sm font-bold bg-white focus:ring-1 focus:ring-school-green outline-none">
                        </div>
                        <div class="flex gap-4">
                            <span class="flex items-center gap-1 text-[10px] font-bold text-gray-500 uppercase tracking-tighter"><div class="w-2.5 h-2.5 rounded-full bg-green-500"></div> Presente</span>
                            <span class="flex items-center gap-1 text-[10px] font-bold text-gray-500 uppercase tracking-tighter"><div class="w-2.5 h-2.5 rounded-full bg-red-500"></div> Falta</span>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-200 pt-3">
                        <label class="text-[9px] font-bold text-school-green uppercase tracking-widest mb-2 block"><i class="fas fa-history mr-1"></i> Histórico de Chamadas Salvas</label>
                        <div id="attendance-history-strip" class="flex gap-2 overflow-x-auto hide-scroll-x pb-1">
                            <!-- Preenchido via JS -->
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-100"><tbody id="attendance-body" class="bg-white"></tbody></table></div>
                <div class="p-4 bg-gray-50 border-t flex justify-end gap-2" id="attendance-actions">
                    <button onclick="openReportsModal('attendance')" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-gray-100 transition flex items-center gap-2"><i class="fas fa-print"></i> Relatório PDF</button>
                    <button onclick="saveDailyAttendance()" class="bg-school-green text-white px-6 py-2 rounded-lg text-sm font-bold shadow hover:bg-green-700 transition flex items-center gap-2"><i class="fas fa-save"></i> Salvar Chamada</button>
                </div>
            </div>

            <!-- Tabela Diário -->
            <div id="view-daily" class="max-w-5xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden hidden fade-in border border-gray-200">
                <div class="p-4 border-b bg-gray-50 flex flex-col md:flex-row md:justify-between items-start md:items-center gap-3">
                    <div>
                        <h3 class="font-bold text-gray-500 text-xs uppercase tracking-widest">Diário de Atividades</h3>
                        <div id="daily-history-strip" class="flex gap-2 overflow-x-auto hide-scroll-x mt-2">
                            <!-- Preenchido via JS -->
                        </div>
                    </div>
                    <input type="date" id="daily-date" onchange="loadDailyData()" class="border border-gray-200 rounded-lg p-2 text-sm font-bold bg-white focus:ring-1 focus:ring-school-green outline-none">
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-100">
                        <thead class="bg-gray-50 text-[10px] font-bold text-gray-400 uppercase text-center">
                            <tr><th class="px-4 py-4 text-left">Estudante</th><th class="w-32">Dever</th><th class="w-48">Comportamento</th><th class="w-48">Anotação (Opcional)</th></tr>
                        </thead>
                        <tbody id="daily-body" class="bg-white text-sm"></tbody>
                    </table>
                </div>
                <div class="p-4 bg-gray-50 border-t flex justify-end gap-2" id="daily-actions">
                    <button onclick="openReportsModal('daily')" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-gray-100 transition flex items-center gap-2"><i class="fas fa-print"></i> Relatório PDF</button>
                    <button onclick="saveDailyLog()" class="bg-blue-600 text-white px-6 py-2 rounded-lg text-sm font-bold shadow hover:bg-blue-700 transition flex items-center gap-2"><i class="fas fa-book"></i> Gravar Diário</button>
                </div>
            </div>

            <!-- Tabela Atividades -->
            <div id="view-activities" class="max-w-5xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden hidden fade-in border border-gray-200">
                <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-gray-700 text-sm uppercase tracking-widest">Material e Atividades em PDF</h3>
                        <p class="text-[10px] text-gray-500 uppercase mt-1">Materiais disponíveis para download</p>
                    </div>
                    <button onclick="openSendActivityModal()" id="btn-new-activity" class="bg-school-green text-white px-4 py-2 rounded-lg text-xs font-bold uppercase flex items-center gap-2 shadow-sm hover:bg-green-700 transition hidden"><i class="fas fa-upload"></i> Enviar Arquivo</button>
                </div>
                <div class="p-6">
                    <div id="activities-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Carregado via JS -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAIS GERAIS -->

    <!-- MODAL: RELATÓRIOS PDF (NOVO) -->
    <div id="modal-reports" class="fixed inset-0 bg-black bg-opacity-80 hidden z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl flex flex-col overflow-hidden">
            <div class="p-4 border-b bg-gray-50 rounded-t-2xl flex justify-between items-center">
                <h3 class="font-bold text-gray-800 uppercase tracking-widest text-sm leading-tight" id="reports-modal-title">Gerador de Relatórios</h3>
                <button onclick="closeModal('modal-reports')" class="text-gray-400 hover:text-red-500 transition"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="p-6 bg-white space-y-4">
                <input type="hidden" id="report-type-input">
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Período</label>
                    <select id="report-period" class="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-1 focus:ring-school-green bg-gray-50">
                        <option value="all">Todo o Histórico</option>
                        <option value="today">Apenas Hoje</option>
                        <option value="week">Última Semana</option>
                        <option value="month">Último Mês</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Aluno Específico (Opcional)</label>
                    <select id="report-student" class="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-1 focus:ring-school-green bg-gray-50">
                        <!-- Carregado dinamicamente -->
                    </select>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 rounded-b-2xl flex justify-end gap-2">
                <button onclick="closeModal('modal-reports')" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-xs font-bold uppercase">Cancelar</button>
                <button onclick="generateFilteredPDF()" class="px-6 py-2 bg-blue-600 text-white rounded-lg text-xs font-bold uppercase shadow flex items-center gap-2"><i class="fas fa-file-pdf"></i> Gerar PDF</button>
            </div>
        </div>
    </div>

    <!-- MODAL: NOTIFICAÇÕES (COORD/DIR) -->
    <div id="modal-notifications" class="fixed inset-0 bg-black bg-opacity-70 hidden z-[100] flex items-center justify-end p-4 backdrop-blur-sm" onclick="if(event.target===this) closeModal('modal-notifications')">
        <div class="bg-white rounded-l-2xl shadow-2xl w-full max-w-sm h-full flex flex-col animate-[slideInRight_0.3s_ease-out]">
            <div class="p-4 border-b bg-school-green text-white flex justify-between items-center">
                <h3 class="font-bold uppercase tracking-widest text-sm"><i class="fas fa-bell mr-2"></i> Log de Atividades</h3>
                <button onclick="closeModal('modal-notifications')" class="text-green-200 hover:text-white transition"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="p-4 flex-1 overflow-y-auto bg-gray-50 space-y-3" id="notifications-list">
                <!-- Preenchido via JS -->
            </div>
            <div class="p-3 border-t bg-white text-center">
                <button onclick="clearNotifications()" class="text-[10px] text-gray-400 uppercase font-bold hover:text-red-500">Limpar Histórico</button>
            </div>
        </div>
    </div>

    <!-- MODAL: CONFIGURAÇÕES GLOBAIS (ADMIN PROFISSIONAL) -->
    <div id="modal-config" class="fixed inset-0 bg-black bg-opacity-80 hidden z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-3xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden">
            <div class="p-4 border-b bg-gray-50 rounded-t-2xl flex justify-between items-center z-10">
                <div class="flex items-center gap-3">
                    <div class="bg-school-green p-2 rounded-lg text-white"><i class="fas fa-sliders-h"></i></div>
                    <div>
                        <h3 class="font-bold text-gray-800 uppercase tracking-widest text-sm leading-tight">Configurações Globais</h3>
                        <p class="text-[10px] text-gray-500 uppercase">Ajuste de Matérias, Turmas e Currículo</p>
                    </div>
                </div>
                <button onclick="closeModal('modal-config')" class="text-gray-400 hover:text-red-500 transition"><i class="fas fa-times fa-lg"></i></button>
            </div>
            
            <div class="flex border-b bg-white">
                <button id="cfg-tab-btn-classes" onclick="switchConfigTab('classes')" class="flex-1 py-3 text-xs font-bold border-b-2 border-school-green text-school-green uppercase tracking-widest transition">1. Turmas</button>
                <button id="cfg-tab-btn-subjects" onclick="switchConfigTab('subjects')" class="flex-1 py-3 text-xs font-bold border-b-2 border-transparent text-gray-500 hover:text-school-green uppercase tracking-widest transition">2. Disciplinas</button>
                <button id="cfg-tab-btn-curriculum" onclick="switchConfigTab('curriculum')" class="flex-1 py-3 text-xs font-bold border-b-2 border-transparent text-gray-500 hover:text-school-green uppercase tracking-widest transition">3. Matriz Curricular</button>
            </div>

            <div class="p-6 overflow-y-auto flex-1 bg-gray-50">
                <!-- Aba Turmas -->
                <div id="cfg-tab-classes" class="space-y-4">
                    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                        <label class="text-xs font-bold text-gray-700 uppercase mb-2 block"><i class="fas fa-plus-circle text-school-green mr-1"></i> Adicionar Turma</label>
                        <div class="flex gap-2">
                            <input type="text" id="config-new-class" class="flex-1 border border-gray-200 p-2.5 rounded-lg text-sm outline-none focus:border-school-green bg-gray-50" placeholder="Ex: 6º Ano A" onkeypress="if(event.key === 'Enter') addConfigClass()">
                            <button onclick="addConfigClass()" class="bg-blue-600 text-white px-5 rounded-lg font-bold shadow hover:bg-blue-700 transition">Adicionar</button>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                        <label class="text-xs font-bold text-gray-700 uppercase mb-3 block"><i class="fas fa-list text-school-green mr-1"></i> Turmas Cadastradas</label>
                        <div id="config-classes-list" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Aba Disciplinas -->
                <div id="cfg-tab-subjects" class="space-y-4 hidden">
                    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                        <label class="text-xs font-bold text-gray-700 uppercase mb-2 block"><i class="fas fa-plus-circle text-school-green mr-1"></i> Adicionar Disciplina</label>
                        <div class="flex gap-2">
                            <input type="text" id="config-new-subject" class="flex-1 border border-gray-200 p-2.5 rounded-lg text-sm outline-none focus:border-school-green bg-gray-50" placeholder="Ex: Robótica" onkeypress="if(event.key === 'Enter') addConfigSubject()">
                            <button onclick="addConfigSubject()" class="bg-blue-600 text-white px-5 rounded-lg font-bold shadow hover:bg-blue-700 transition">Adicionar</button>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                        <label class="text-xs font-bold text-gray-700 uppercase mb-3 block"><i class="fas fa-list text-school-green mr-1"></i> Disciplinas Cadastradas</label>
                        <div id="config-subjects-list" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Aba Matriz Curricular -->
                <div id="cfg-tab-curriculum" class="space-y-4 hidden">
                    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                        <p class="text-xs text-gray-500 mb-4 leading-relaxed">Selecione uma turma para definir quais disciplinas são ensinadas nela. Isso reflete no aplicativo dos pais para que eles só vejam o que o aluno realmente cursa.</p>
                        <label class="text-xs font-bold text-gray-700 uppercase mb-2 block">Selecione a Turma</label>
                        <select id="config-curriculum-class" onchange="renderCurriculumCheckboxes()" class="w-full border border-gray-200 p-2.5 rounded-lg text-sm outline-none focus:border-school-green bg-gray-50 font-bold text-school-green mb-4"></select>
                        
                        <label class="text-xs font-bold text-gray-700 uppercase mb-3 block border-t pt-4">Disciplinas da Turma</label>
                        <div id="config-curriculum-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t bg-white rounded-b-2xl flex justify-between items-center gap-2">
                <span class="text-[10px] text-gray-400 italic" id="cfg-unsaved-warn"></span>
                <div class="flex gap-2">
                    <button onclick="closeModal('modal-config')" class="px-5 py-2.5 bg-gray-100 text-gray-600 rounded-lg text-xs font-bold uppercase hover:bg-gray-200 transition">Fechar</button>
                    <button onclick="saveGlobalConfig()" class="px-6 py-2.5 bg-school-green text-white rounded-lg font-bold shadow-lg hover:bg-green-700 transition uppercase text-xs flex items-center gap-2"><i class="fas fa-save"></i> Salvar Tudo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: ENVIAR ATIVIDADE PDF -->
    <div id="modal-send-activity" class="fixed inset-0 bg-black bg-opacity-70 hidden z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="font-bold text-lg mb-1 text-school-green uppercase tracking-widest border-b pb-2">Nova Atividade PDF</h3>
            <p class="text-[10px] text-gray-500 mb-4 uppercase">Para: <span id="act-class-display" class="font-bold">--</span> | <span id="act-subj-display" class="font-bold">--</span></p>
            
            <label class="block text-[10px] font-bold text-gray-600 uppercase mb-1">Título da Atividade</label>
            <input type="text" id="act-title" class="w-full border p-2.5 rounded-lg text-sm mb-3 outline-none focus:ring-1 focus:ring-school-green" placeholder="Ex: Lista de Exercícios 01">
            
            <label class="block text-[10px] font-bold text-gray-600 uppercase mb-1">Arquivo PDF (Max: 800KB)</label>
            <div class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center hover:bg-gray-50 transition cursor-pointer mb-4 relative">
                <input type="file" id="act-file" accept="application/pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="previewActivityFile(this)">
                <i class="fas fa-file-pdf text-3xl text-red-400 mb-2"></i>
                <p id="act-file-name" class="text-xs text-gray-500 font-bold truncate">Clique ou arraste o PDF aqui</p>
            </div>

            <div class="flex justify-end gap-2 border-t pt-4">
                <button onclick="closeModal('modal-send-activity')" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-bold uppercase hover:bg-gray-200">Cancelar</button>
                <button onclick="submitActivity()" class="px-4 py-2 bg-school-green text-white rounded-lg text-sm font-bold shadow uppercase hover:bg-green-700 flex items-center gap-2"><i class="fas fa-paper-plane"></i> Enviar para Turma</button>
            </div>
        </div>
    </div>

    <!-- MODAL: JUSTIFICAR -->
    <div id="modal-justification" class="fixed inset-0 bg-black bg-opacity-70 hidden z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm shadow-2xl">
            <h3 class="font-bold text-lg mb-2 text-school-green">Justificar Falta</h3>
            <p class="text-xs text-gray-500 mb-4" id="just-date-display">--</p>
            <select id="just-reason" class="w-full border p-2 rounded text-sm mb-3 font-bold text-gray-600">
                <option>Médico</option><option>Pessoal</option><option>Outro</option>
            </select>
            <label class="block text-xs font-bold text-gray-700 mb-1">Foto (Opcional)</label>
            <input type="file" id="just-file" accept="image/*" class="w-full text-xs border p-2 rounded mb-4">
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-justification')" class="px-4 py-2 bg-gray-200 rounded text-sm font-bold">Cancelar</button>
                <button onclick="submitJustification()" class="px-4 py-2 bg-school-green text-white rounded text-sm font-bold shadow hover:bg-green-700">Enviar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: COORDENAÇÃO -->
    <div id="modal-coord" class="fixed inset-0 bg-black bg-opacity-70 hidden z-[90] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg w-full max-w-4xl h-[90vh] flex flex-col shadow-2xl">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h3 class="font-bold text-gray-800 uppercase text-xs tracking-widest">Painel de Coordenação</h3>
                <button onclick="closeModal('modal-coord')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 flex-1 overflow-y-auto grid md:grid-cols-2 gap-6 bg-gray-100">
                <div class="bg-white border rounded-xl p-4 shadow-sm">
                    <h4 class="font-bold mb-4 text-xs uppercase text-gray-400 tracking-widest">Professores Online</h4>
                    <div id="coord-teachers-list" class="space-y-2"></div>
                </div>
                <div class="bg-white border rounded-xl p-4 shadow-sm">
                    <h4 class="font-bold mb-4 text-xs uppercase text-gray-400 tracking-widest">Justificativas Pendentes</h4>
                    <div id="coord-pending-list" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: GESTÃO DE USUÁRIOS (ADMIN) -->
    <div id="modal-users" class="fixed inset-0 bg-black bg-opacity-75 hidden z-[90] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh]">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl">
                <h3 class="font-bold text-gray-800 uppercase text-xs tracking-widest">Controle de Usuários</h3>
                <button onclick="closeModal('modal-users')" class="text-gray-300 hover:text-red-500 transition"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="p-4 overflow-y-auto flex-1">
                <div class="flex gap-2 mb-4 bg-gray-100 p-1 rounded-lg">
                    <button onclick="switchUserTab('teacher')" id="tab-teacher" class="flex-1 py-2 font-bold text-[10px] uppercase rounded-md transition bg-white shadow-sm text-gray-800">Staff / Professores</button>
                    <button onclick="switchUserTab('parent')" id="tab-parent" class="flex-1 py-2 font-bold text-[10px] uppercase rounded-md transition text-gray-400">Pais / Alunos</button>
                </div>
                <div class="bg-blue-50 p-4 rounded-xl mb-4 border border-blue-100 shadow-inner">
                    <div class="grid gap-3">
                        <input type="hidden" id="edit-user-id">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="new-u-name" placeholder="Nome Completo" class="border p-2.5 rounded-lg text-sm bg-white">
                            <input type="text" id="new-u-display" placeholder="Nome Exibição" class="border p-2.5 rounded-lg text-sm bg-white">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="new-u-login" placeholder="Login" class="border p-2.5 rounded-lg text-sm bg-white">
                            <input type="text" id="new-u-pass" placeholder="Nova Senha (deixe em branco para manter)" class="border p-2.5 rounded-lg text-sm bg-white">
                        </div>
                        
                        <div id="field-teacher-subj">
                            <label class="text-[9px] font-bold text-gray-400 uppercase ml-1 mb-1 block">Nível de Acesso</label>
                            <select id="new-u-role" class="w-full border p-2.5 rounded-lg text-sm bg-white mb-3 font-bold text-gray-700 shadow-sm">
                                <option value="teacher">Professor(a)</option>
                                <option value="coord">Coordenador(a)</option>
                                <option value="admin">Administrador(a)</option>
                            </select>

                            <label class="text-[9px] font-bold text-gray-400 uppercase ml-1 block mb-1">Atribuições (Matéria -> Turmas)</label>
                            <div id="assignments-container" class="max-h-48 overflow-y-auto bg-white p-1 border rounded-lg shadow-sm mb-2">
                                <!-- Preenchido dinamicamente via JS -->
                            </div>
                        </div>
                        
                        <div id="field-parent-student" class="hidden">
                            <input type="text" id="new-u-student-id" placeholder="ID do Aluno (Copie da Tabela de Notas)" class="border p-2.5 rounded-lg text-sm w-full bg-white">
                        </div>
                        
                        <div class="flex gap-2 mt-2 pt-2 border-t border-blue-100">
                            <button onclick="cancelEdit()" id="btn-cancel-edit" class="hidden flex-1 bg-white text-gray-500 py-2.5 rounded-lg text-xs font-bold uppercase border border-gray-200">Cancelar</button>
                            <button onclick="saveUserOps()" id="btn-save-user" class="flex-[2] bg-blue-600 text-white py-2.5 rounded-lg text-xs font-bold uppercase shadow-lg hover:bg-blue-700 transition">Salvar Cadastro</button>
                        </div>
                    </div>
                </div>
                <div id="users-list" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- MODAL: ADD ALUNO / IMPORTAR -->
    <div id="modal-add" class="fixed inset-0 bg-black bg-opacity-75 hidden z-[95] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
            <h3 class="font-bold text-gray-700 mb-4">Adicionar Aluno</h3>
            <input type="text" id="new-name" class="w-full border p-2 rounded mb-4" placeholder="Nome do Aluno">
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-add')" class="px-4 py-2 text-gray-500 text-sm font-bold">Cancelar</button>
                <button onclick="addStudent()" class="px-4 py-2 bg-school-green text-white rounded text-sm font-bold">Salvar</button>
            </div>
        </div>
    </div>
    
    <div id="modal-import" class="fixed inset-0 bg-black bg-opacity-75 hidden z-[95] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="font-bold text-gray-700 mb-2">Importar em Massa</h3>
            <p class="text-xs text-gray-400 mb-2">Cole os nomes, um por linha.</p>
            <textarea id="import-list" class="w-full border p-2 rounded mb-4 h-40 text-sm" placeholder="Nome Aluno 1&#10;Nome Aluno 2..."></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-import')" class="px-4 py-2 text-gray-500 text-sm font-bold">Cancelar</button>
                <button onclick="importStudents()" class="px-4 py-2 bg-blue-600 text-white rounded text-sm font-bold">Processar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: CHAT INTERNO -->
    <div id="modal-chat" class="fixed inset-0 bg-black bg-opacity-80 hidden z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[85vh] flex flex-col overflow-hidden">
            <div class="p-4 bg-school-green text-white flex justify-between items-center z-10">
                <div class="flex items-center gap-3">
                    <i class="fas fa-comments text-2xl"></i>
                    <div>
                        <h3 class="font-bold leading-none mb-1">Comunicação Interna</h3>
                        <div class="text-[10px] text-green-100 uppercase font-bold tracking-widest flex items-center gap-2">
                            <span id="chat-recipient-info">Avisos Gerais</span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 items-center">
                    <button id="btn-clear-chat" onclick="clearConversation()" class="hidden text-[10px] bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded uppercase font-bold tracking-widest shadow-sm transition"><i class="fas fa-trash-alt mr-1"></i> Limpar Conversa</button>
                    <button onclick="closeModal('modal-chat')" class="hover:text-red-200 transition p-2"><i class="fas fa-times fa-lg"></i></button>
                </div>
            </div>
            
            <div class="flex flex-1 overflow-hidden relative">
                <!-- Sidebar Contatos -->
                <div id="chat-sidebar" class="w-full md:w-72 border-r bg-gray-50 overflow-y-auto flex flex-col z-10 hidden md:flex absolute md:static inset-0">
                    <div class="p-3">
                        <button onclick="setChatRecipient('global', 'Avisos Gerais')" class="w-full text-left p-4 rounded-xl border-2 border-transparent transition hover:border-green-300 bg-white shadow-sm flex items-center gap-3 mb-4 relative" id="chat-btn-global">
                            <div class="w-10 h-10 bg-green-100 text-school-green rounded-full flex items-center justify-center"><i class="fas fa-bullhorn"></i></div>
                            <div class="flex-1">
                                <div class="text-sm font-bold text-gray-700 leading-none flex justify-between">Mural Geral</div>
                                <div class="text-[9px] text-gray-400 mt-1 uppercase font-bold">Público</div>
                            </div>
                        </button>
                        <div class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-3 ml-2 border-b pb-1">Diretório Interno</div>
                        <div id="chat-user-list" class="space-y-1"></div>
                    </div>
                </div>

                <!-- Mensagens -->
                <div class="flex-1 flex flex-col bg-white w-full" id="chat-main-window">
                    <div class="md:hidden bg-gray-100 p-2 border-b text-xs flex justify-between items-center">
                        <button onclick="document.getElementById('chat-sidebar').classList.remove('hidden'); document.getElementById('chat-main-window').classList.add('hidden');" class="text-blue-600 font-bold"><i class="fas fa-chevron-left"></i> Voltar</button>
                        <span class="font-bold text-gray-600 uppercase" id="mobile-chat-title">Mural Geral</span>
                    </div>

                    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 bg-gray-100 flex flex-col gap-2"></div>
                    
                    <div id="chat-attachment-preview" class="hidden p-3 bg-blue-50 border-t flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-file-alt text-blue-500"></i>
                            <span id="attachment-name" class="text-xs text-blue-800 font-bold truncate max-w-[200px]"></span>
                        </div>
                        <button onclick="clearChatAttachment()" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-times-circle"></i></button>
                    </div>

                    <div id="chat-input-area" class="p-4 border-t bg-white flex gap-2 items-center">
                        <label class="cursor-pointer text-gray-400 hover:text-school-green p-2 transition">
                            <i class="fas fa-paperclip fa-lg"></i>
                            <input type="file" id="chat-file" class="hidden" onchange="handleChatFile(this)">
                        </label>
                        <input id="chat-input" class="flex-1 border-2 border-gray-100 p-3 rounded-xl text-sm outline-none focus:border-school-green transition" placeholder="Escreva sua mensagem..." onkeypress="if(event.key === 'Enter') sendChatMessage()">
                        <button onclick="sendChatMessage()" class="bg-school-green text-white p-3 rounded-xl w-12 h-12 flex items-center justify-center shadow-lg hover:bg-green-700 transition">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL RELATÓRIO V29 (ACADÊMICO UNIFICADO) -->
    <div id="modal-report" class="fixed inset-0 bg-black bg-opacity-70 hidden z-[90] flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-2xl w-full max-w-4xl flex flex-col max-h-[90vh] shadow-2xl">
            <div class="p-6 border-b flex justify-between items-start bg-gray-50 rounded-t-2xl">
                <div class="flex items-center gap-4">
                    <img src="https://i.ibb.co/JWKSzsWy/colegio-concenal-2.webp" onerror="this.src='https://placehold.co/150x50/png?text=CONCENAL'" class="h-12 bg-white p-1 rounded shadow-sm">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800" id="report-name">--</h2>
                        <p class="text-[10px] text-gray-400 uppercase font-bold tracking-widest">Histórico Acadêmico Unificado</p>
                    </div>
                </div>
                <button onclick="closeModal('modal-report')" class="no-print text-gray-300 hover:text-red-500 transition"><i class="fas fa-times fa-lg"></i></button>
            </div>
            
            <div class="p-6 flex-1 overflow-y-auto bg-white">
                <div class="overflow-x-auto mb-6">
                    <table class="min-w-full divide-y divide-gray-200 text-center border">
                        <thead class="bg-gray-100 text-gray-500 font-bold text-[10px] uppercase">
                            <tr>
                                <th class="px-4 py-3 text-left">Disciplina</th>
                                <th class="w-10">U1</th><th class="w-10">U2</th><th class="w-10">U3</th><th class="w-10">U4</th><th class="w-10">U5</th><th class="w-10">U6</th>
                                <th class="w-16 border-l">Faltas</th>
                                <th class="w-16 border-l">Média</th>
                                <th class="w-14 border-l text-red-500">Rec</th>
                                <th class="w-24 border-l">Situação</th>
                            </tr>
                        </thead>
                        <tbody id="unified-report-body" class="bg-white divide-y divide-gray-100 text-xs">
                            <!-- Preenchido via JS -->
                        </tbody>
                    </table>
                </div>

                <div class="bg-gray-50 p-5 rounded-2xl border border-gray-200">
                    <h4 class="font-bold text-gray-500 border-b pb-2 uppercase text-[10px] tracking-widest mb-4">Relatório Pedagógico (Todas as Disciplinas)</h4>
                    <div id="observations-list" class="space-y-3 mb-4 max-h-48 overflow-y-auto pr-2"></div>
                    
                    <div id="report-tools" class="mt-4 pt-4 border-t border-dashed no-print">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2 ml-1">Nova Observação para <span id="obs-subject-label" class="text-school-green"></span></label>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input type="date" id="new-observation-date" class="border border-gray-300 rounded-lg p-2 text-xs text-gray-600 focus:outline-none w-full sm:w-32">
                            <input type="text" id="new-observation-text" class="flex-1 border border-gray-300 rounded-lg p-2 text-xs focus:border-school-green outline-none transition" placeholder="Escreva o parecer aqui...">
                            <button onclick="addObservation()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-[10px] font-bold uppercase shadow-sm hover:bg-blue-700 transition">Salvar</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-gray-50 rounded-b-2xl flex justify-end no-print gap-2">
                <button onclick="printUnifiedReport()" class="bg-gray-800 text-white px-6 py-2 rounded-lg font-bold text-xs uppercase shadow hover:bg-black transition flex items-center gap-2"><i class="fas fa-print"></i> Imprimir Boletim</button>
            </div>
        </div>
    </div>

    <!-- Script de Funcionalidade -->
    <script>
        // --- CONSTANTES V29 ---
        const DEFAULT_CLASSES = ["6A", "6B", "7A", "7B", "8A", "8B", "9A", "9B", "1º EM A", "2º EM A", "3º EM A"];
        const DEFAULT_SUBJECTS = ["Matemática", "Português", "Geografia", "História", "Arte", "Educação Física", "Inglês", "Ciências", "Física", "Química", "Biologia", "Projeto de Vida", "Ciências Humanas", "Espanhol"];
        const SUBJECT_DAYS = { "Matemática": 200, "Português": 200, "default": 80 };
        const today = new Date().toISOString().split('T')[0];
        
        // --- ESTADO GLOBAL ---
        let db, auth, currentUser = null;
        let appData = {
            students: [],
            activities: [],
            currentClass: '',
            currentSubject: '',
            currentMode: 'grades',
            allSubjects: [],
            allClasses: [],
            curriculum: {}, // Mapeamento Turma -> Matérias
            isProcessing: false
        };
        
        let tempConfigClasses = [];
        let tempConfigSubjects = [];
        let tempCurriculum = {};

        let tempAttendance = {};
        let tempDaily = {};
        let creatingUserType = 'teacher';
        
        // Chat State
        let currentChatFile = null;
        let chatRecipient = 'global';
        let chatRecipientName = 'Avisos Gerais';
        let currentChatMessages = [];
        let knownMessages = new Set();
        let isFirstChatLoad = true;
        let unreadCounts = {};

        let currentStudentForReport = null;
        let currentJustificationStudentId = null;
        let currentJustificationDate = null;
        let currentActivityFile = null;
        let unsubscribe = null;
        let activitiesUnsubscribe = null;
        let userProfileUnsubscribe = null;
        let notificationsUnsubscribe = null;

        // --- INICIALIZAÇÃO FIREBASE REFORÇADA ---
        const initFirebase = async () => {
            const setupScreen = document.getElementById('setup-screen');
            const setupErrorLog = document.getElementById('setup-error-log');
            try {
                let firebaseConfig = null;
                try {
                    if (typeof window !== 'undefined' && window.__firebase_config) {
                        firebaseConfig = JSON.parse(window.__firebase_config);
                    } else if (typeof __firebase_config !== 'undefined') {
                        firebaseConfig = JSON.parse(__firebase_config);
                    }
                } catch(err) {
                    console.log("Config nativa do ambiente não encontrada, utilizando fallback manual.");
                }

                if (!firebaseConfig) {
                    firebaseConfig = {
                        apiKey: "AIzaSyAqeEtvS5mnYffNj1VLgxSbxX1NJ1n7u7c",
                        authDomain: "concenal.firebaseapp.com",
                        projectId: "concenal",
                        storageBucket: "concenal.firebasestorage.app",
                        messagingSenderId: "1021506175689",
                        appId: "1:1021506175689:web:15b7af6919ac02bbc88318"
                    };
                }

                const appId = (typeof window !== 'undefined' && window.__app_id) ? window.__app_id : (typeof __app_id !== 'undefined' ? __app_id : 'default-app-id');
                window.APP_ID = appId;

                if(!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                
                try {
                    db.settings({ experimentalForceLongPolling: true, useFetchStreams: false });
                } catch (e) {}
                
                auth = firebase.auth();
                
                let customToken = null;
                try {
                    if (typeof window !== 'undefined' && window.__initial_auth_token) {
                        customToken = window.__initial_auth_token;
                    } else if (typeof __initial_auth_token !== 'undefined') {
                        customToken = __initial_auth_token;
                    }
                } catch(e) {}
                
                if (customToken) {
                    await auth.signInWithCustomToken(customToken);
                } else {
                    await auth.signInAnonymously();
                }

                await ensureAdminUser();

                getCollection('concenal_config').doc('general').onSnapshot(doc => {
                    if(appData.isProcessing) return;

                    if (doc.exists) {
                        appData.allSubjects = doc.data().subjects || DEFAULT_SUBJECTS;
                        appData.allClasses = doc.data().classes || DEFAULT_CLASSES;
                        appData.curriculum = doc.data().curriculum || {};
                    } else {
                        appData.allSubjects = DEFAULT_SUBJECTS;
                        appData.allClasses = DEFAULT_CLASSES;
                        appData.curriculum = {};
                        getCollection('concenal_config').doc('general').set({ subjects: DEFAULT_SUBJECTS, classes: DEFAULT_CLASSES, curriculum: {} }, { merge: true });
                    }
                    
                    if(!appData.currentSubject && appData.allSubjects.length > 0) appData.currentSubject = appData.allSubjects[0];
                    if(!appData.currentClass && appData.allClasses.length > 0) appData.currentClass = appData.allClasses[0];

                    if(currentUser) {
                        loadParentSubjectsAndPopulate();
                    }
                    
                    if(!document.getElementById('modal-users').classList.contains('hidden')) {
                       renderAssignmentsUI();
                    }
                });

                auth.onAuthStateChanged(user => {
                    if (user) checkLocalSession();
                });

                document.getElementById('attendance-date').value = today;
                document.getElementById('daily-date').value = today;
                document.getElementById('new-observation-date').value = today;
                
                setupScreen.classList.add('hidden');

            } catch (e) {
                console.error("Firebase Initialization Critical Error:", e);
                if(setupErrorLog) setupErrorLog.innerText = e.message;
                setupScreen.classList.remove('hidden');
            }
        };

        function getCollection(name) {
            return db.collection('artifacts').doc(window.APP_ID).collection('public').doc('data').collection(name);
        }

        async function ensureAdminUser() {
            try {
                const snapshot = await getCollection('concenal_users').get();
                let hasAdmin = false;
                snapshot.forEach(doc => {
                    if (doc.data().username === 'admin') hasAdmin = true;
                });
                
                if (!hasAdmin) {
                    await getCollection('concenal_users').add({
                        username: 'admin',
                        password: '123',
                        name: 'Administrador Padrão',
                        displayName: 'Direção',
                        role: 'admin',
                        subjects: DEFAULT_SUBJECTS,
                        classes: DEFAULT_CLASSES,
                        assignments: {}
                    });
                }
            } catch(e) {}
        }

        // --- GLOBAL SCOPE FUNCTIONS ---
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function switchMode(m) { appData.currentMode = m; updateUI(); }
        function changeSubject(v) { 
            appData.currentSubject = v; 
            if(currentUser && currentUser.role !== 'parent') populateClassSelect(); 
            updateUI(); 
        }
        function changeClass(v) { appData.currentClass = v; updateUI(); }
        function openAddModal() { document.getElementById('modal-add').classList.remove('hidden'); }
        function showHistory(id) { openReportModal(id); }
        function openUsersModal() { document.getElementById('modal-users').classList.remove('hidden'); loadUsersList(); switchUserTab('teacher'); }

        function checkLocalSession() {
            const s = localStorage.getItem('concenal_v29_session');
            if(s) { 
                try {
                    currentUser = JSON.parse(s); 
                    showApp(); 
                } catch(e) {
                    localStorage.removeItem('concenal_v29_session');
                    document.getElementById('login-screen').classList.remove('hidden'); 
                }
            } else { 
                document.getElementById('login-screen').classList.remove('hidden'); 
            }
        }

        // --- MÓDULO DE NOTIFICAÇÕES GERAIS ---
        async function logAction(type, description) {
            if(!currentUser || currentUser.role === 'parent') return;
            try {
                await getCollection('concenal_notifications').add({
                    type: type, // 'Chamada', 'Diário', 'Atividade'
                    description: description,
                    teacherName: currentUser.displayName || currentUser.name,
                    className: appData.currentClass,
                    subjectName: appData.currentSubject,
                    timestamp: Date.now()
                });
            } catch(e) { console.error("Erro ao notificar ação:", e); }
        }

        function openNotifications() {
            document.getElementById('modal-notifications').classList.remove('hidden');
            const mainBadge = document.getElementById('notif-badge');
            if(mainBadge) mainBadge.classList.add('hidden');
        }

        async function clearNotifications() {
            if(confirm("Apagar o log de notificações recente?")) {
                const snap = await getCollection('concenal_notifications').get();
                const batch = db.batch();
                snap.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
            }
        }

        // --- POPULATE DROPDOWNS & DYNAMIC PARENT DATA ---
        async function loadParentSubjectsAndPopulate() {
            const ss = document.getElementById('subject-select');
            if (!ss || !currentUser) return;

            let allowedSubjects = [];

            if (currentUser.role === 'teacher') {
                if (currentUser.assignments && Object.keys(currentUser.assignments).length > 0) {
                    allowedSubjects = Object.keys(currentUser.assignments).filter(s => currentUser.assignments[s].length > 0).sort();
                } else if (currentUser.subjects) {
                    allowedSubjects = [...currentUser.subjects].sort();
                } else {
                    allowedSubjects = [];
                }
            } else if (currentUser.role === 'parent') {
                const student = appData.students.find(s => s.id === currentUser.studentId);
                const stClass = student ? student.class : appData.currentClass;
                
                let parentSubjectsSet = new Set(appData.curriculum[stClass] || []);
                
                if (student && student.subjects) {
                    Object.keys(student.subjects).forEach(s => parentSubjectsSet.add(s));
                }

                allowedSubjects = Array.from(parentSubjectsSet).sort();
            } else {
                allowedSubjects = [...appData.allSubjects].sort();
            }

            ss.innerHTML = allowedSubjects.map(s => `<option value="${s}">${s}</option>`).join('');
            
            if(appData.currentSubject && allowedSubjects.includes(appData.currentSubject)) {
                ss.value = appData.currentSubject;
            } else if (allowedSubjects.length > 0) {
                appData.currentSubject = allowedSubjects[0];
                ss.value = allowedSubjects[0];
            } else {
                appData.currentSubject = '';
                ss.innerHTML = '<option value="">Nenhuma disciplina</option>';
            }

            if(currentUser.role !== 'parent') {
                populateClassSelect();
            }
            updateUI();
        }

        function populateClassSelect() {
            const s = document.getElementById('class-select'); 
            if(!s || !currentUser || currentUser.role === 'parent') return;
            
            let allowedClasses = [...appData.allClasses];
            
            if (currentUser.role === 'teacher') {
                if (currentUser.assignments && Object.keys(currentUser.assignments).length > 0) {
                    allowedClasses = currentUser.assignments[appData.currentSubject] || [];
                } else if (currentUser.classes) {
                    allowedClasses = currentUser.classes;
                } else {
                    allowedClasses = [];
                }
            }
            
            s.innerHTML = allowedClasses.map(c => `<option value="${c}">${c}</option>`).join('');
            
            if(appData.currentClass && allowedClasses.includes(appData.currentClass)) {
                s.value = appData.currentClass;
            } else if (allowedClasses.length > 0) {
                appData.currentClass = allowedClasses[0];
                s.value = allowedClasses[0];
            } else {
                appData.currentClass = '';
            }
        }

        // --- MÓDULO DE CONFIGURAÇÃO GLOBAL ---
        function openConfigModal() {
            tempConfigClasses = [...appData.allClasses];
            tempConfigSubjects = [...appData.allSubjects];
            tempCurriculum = JSON.parse(JSON.stringify(appData.curriculum));
            
            switchConfigTab('classes');
            document.getElementById('modal-config').classList.remove('hidden');
        }

        function switchConfigTab(tab) {
            ['classes', 'subjects', 'curriculum'].forEach(t => {
                const btn = document.getElementById(`cfg-tab-btn-${t}`);
                const pane = document.getElementById(`cfg-tab-${t}`);
                if(btn && pane) {
                    if(t === tab) {
                        btn.classList.add('border-school-green', 'text-school-green');
                        btn.classList.remove('border-transparent', 'text-gray-500');
                        pane.classList.remove('hidden');
                    } else {
                        btn.classList.remove('border-school-green', 'text-school-green');
                        btn.classList.add('border-transparent', 'text-gray-500');
                        pane.classList.add('hidden');
                    }
                }
            });

            if (tab === 'classes') renderConfigClasses();
            if (tab === 'subjects') renderConfigSubjects();
            if (tab === 'curriculum') {
                const select = document.getElementById('config-curriculum-class');
                select.innerHTML = tempConfigClasses.map(c => `<option value="${c}">${c}</option>`).join('');
                renderCurriculumCheckboxes();
            }
        }

        function renderConfigClasses() {
            const list = document.getElementById('config-classes-list');
            list.innerHTML = tempConfigClasses.map((c, i) => `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100">
                    <span class="font-bold text-gray-700 text-sm">${c}</span>
                    <div class="flex gap-2">
                        <button onclick="renameConfigClass(${i})" class="text-blue-500 hover:text-blue-700 transition" title="Renomear"><i class="fas fa-edit"></i></button>
                        <button onclick="removeConfigClass(${i})" class="text-red-400 hover:text-red-600 transition" title="Excluir"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
            if(tempConfigClasses.length === 0) list.innerHTML = '<div class="text-xs text-gray-400 italic">Nenhuma turma cadastrada.</div>';
        }

        function renderConfigSubjects() {
            const list = document.getElementById('config-subjects-list');
            list.innerHTML = tempConfigSubjects.map((s, i) => `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100">
                    <span class="font-bold text-gray-700 text-sm">${s}</span>
                    <div class="flex gap-2">
                        <button onclick="renameConfigSubject(${i})" class="text-blue-500 hover:text-blue-700 transition" title="Renomear"><i class="fas fa-edit"></i></button>
                        <button onclick="removeConfigSubject(${i})" class="text-red-400 hover:text-red-600 transition" title="Excluir"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
            if(tempConfigSubjects.length === 0) list.innerHTML = '<div class="text-xs text-gray-400 italic">Nenhuma disciplina cadastrada.</div>';
        }

        function renderCurriculumCheckboxes() {
            const cClass = document.getElementById('config-curriculum-class').value;
            const container = document.getElementById('config-curriculum-checkboxes');
            if(!cClass) { container.innerHTML = ''; return; }
            
            const currentSubjInClass = tempCurriculum[cClass] || [];
            
            container.innerHTML = tempConfigSubjects.map(s => `
                <label class="flex items-center gap-2 p-2 bg-gray-50 border rounded-lg cursor-pointer hover:bg-green-50 transition ${currentSubjInClass.includes(s) ? 'border-green-200' : 'border-gray-100'}">
                    <input type="checkbox" value="${s}" onchange="updateTempCurriculum('${cClass}', this.value, this.checked)" ${currentSubjInClass.includes(s) ? 'checked' : ''} class="w-4 h-4 text-school-green">
                    <span class="text-xs font-bold text-gray-700">${s}</span>
                </label>
            `).join('');
        }

        function updateTempCurriculum(cClass, subj, isChecked) {
            if(!tempCurriculum[cClass]) tempCurriculum[cClass] = [];
            if(isChecked && !tempCurriculum[cClass].includes(subj)) {
                tempCurriculum[cClass].push(subj);
            } else if (!isChecked) {
                tempCurriculum[cClass] = tempCurriculum[cClass].filter(s => s !== subj);
            }
            renderCurriculumCheckboxes(); 
            document.getElementById('cfg-unsaved-warn').innerText = '* Alterações pendentes de salvamento.';
        }

        function addConfigClass() {
            const input = document.getElementById('config-new-class');
            const val = input.value.trim().toUpperCase();
            if(val && !tempConfigClasses.includes(val)) {
                tempConfigClasses.push(val);
                input.value = '';
                renderConfigClasses();
                document.getElementById('cfg-unsaved-warn').innerText = '* Alterações pendentes de salvamento.';
            }
        }

        function removeConfigClass(idx) {
            const cName = tempConfigClasses[idx];
            if(confirm(`Remover turma ${cName}? Isso afetará a visão do sistema, mas não apagará notas antigas já lançadas.`)) {
                tempConfigClasses.splice(idx, 1);
                delete tempCurriculum[cName];
                renderConfigClasses();
                document.getElementById('cfg-unsaved-warn').innerText = '* Alterações pendentes de salvamento.';
            }
        }

        async function renameConfigClass(idx) {
            const oldName = tempConfigClasses[idx];
            const newName = prompt("Novo nome para a turma:", oldName)?.trim().toUpperCase();
            if(!newName || newName === oldName) return;
            if(tempConfigClasses.includes(newName)) return alert("Este nome já existe!");
            
            if(confirm(`Tem certeza? Essa ação vai renomear em todas as configurações globais.`)) {
                tempConfigClasses[idx] = newName;
                if(tempCurriculum[oldName]) {
                    tempCurriculum[newName] = tempCurriculum[oldName];
                    delete tempCurriculum[oldName];
                }
                renderConfigClasses();
                document.getElementById('cfg-unsaved-warn').innerText = '* Renomeação aguardando salvamento.';
            }
        }

        function addConfigSubject() {
            const input = document.getElementById('config-new-subject');
            const val = input.value.trim();
            const formattedVal = val.charAt(0).toUpperCase() + val.slice(1);
            if(formattedVal && !tempConfigSubjects.includes(formattedVal)) {
                tempConfigSubjects.push(formattedVal);
                input.value = '';
                renderConfigSubjects();
                document.getElementById('cfg-unsaved-warn').innerText = '* Alterações pendentes de salvamento.';
            }
        }

        function removeConfigSubject(idx) {
            const sName = tempConfigSubjects[idx];
            if(confirm(`Remover disciplina ${sName}?`)) {
                tempConfigSubjects.splice(idx, 1);
                Object.keys(tempCurriculum).forEach(c => {
                    tempCurriculum[c] = tempCurriculum[c].filter(s => s !== sName);
                });
                renderConfigSubjects();
                document.getElementById('cfg-unsaved-warn').innerText = '* Alterações pendentes de salvamento.';
            }
        }

        async function renameConfigSubject(idx) {
            const oldName = tempConfigSubjects[idx];
            const rawNew = prompt("Novo nome para a disciplina:", oldName)?.trim();
            if(!rawNew || rawNew === oldName) return;
            const newName = rawNew.charAt(0).toUpperCase() + rawNew.slice(1);
            if(tempConfigSubjects.includes(newName)) return alert("Este nome já existe!");

            if(confirm(`ATENÇÃO! Renomear a disciplina vai iniciar uma operação pesada no banco de dados para migrar as notas antigas para o novo nome. Deseja prosseguir?`)) {
                try {
                    document.getElementById('modal-config').classList.add('opacity-50', 'pointer-events-none');
                    document.getElementById('cfg-unsaved-warn').innerText = 'Aplicando migração no banco de dados... Aguarde.';
                    
                    tempConfigSubjects[idx] = newName;
                    Object.keys(tempCurriculum).forEach(c => {
                        tempCurriculum[c] = tempCurriculum[c].map(s => s === oldName ? newName : s);
                    });

                    const snap = await getCollection('concenal_students').get();
                    const docsToUpdate = [];
                    snap.forEach(doc => {
                        const data = doc.data();
                        if (data.subjects && data.subjects[oldName]) docsToUpdate.push({ id: doc.id, data: data.subjects[oldName] });
                    });
                    
                    const CHUNK_SIZE = 450; 
                    for (let i = 0; i < docsToUpdate.length; i += CHUNK_SIZE) {
                        const chunk = docsToUpdate.slice(i, i + CHUNK_SIZE);
                        const batch = db.batch();
                        chunk.forEach(item => {
                            const docRef = getCollection('concenal_students').doc(item.id);
                            const updateData = {};
                            updateData[`subjects.${newName}`] = item.data;
                            updateData[`subjects.${oldName}`] = firebase.firestore.FieldValue.delete();
                            batch.update(docRef, updateData);
                        });
                        await batch.commit();
                    }

                    const payload = { 
                        subjects: tempConfigSubjects, 
                        classes: tempConfigClasses,
                        curriculum: tempCurriculum
                    };
                    try {
                        await getCollection('concenal_config').doc('general').update(payload);
                    } catch (err) {
                        await getCollection('concenal_config').doc('general').set(payload);
                    }

                    alert("Disciplina renomeada e notas migradas com sucesso!");
                    renderConfigSubjects();
                    document.getElementById('cfg-unsaved-warn').innerText = '';

                } catch (e) {
                    alert("Erro na migração: " + e.message);
                } finally {
                    document.getElementById('modal-config').classList.remove('opacity-50', 'pointer-events-none');
                }
            }
        }

        async function saveGlobalConfig() {
            try {
                appData.isProcessing = true;
                document.getElementById('modal-config').classList.add('opacity-50', 'pointer-events-none');
                document.getElementById('cfg-unsaved-warn').innerText = 'Salvando...';
                
                const payload = { 
                    subjects: tempConfigSubjects, 
                    classes: tempConfigClasses,
                    curriculum: tempCurriculum 
                };

                try {
                    await getCollection('concenal_config').doc('general').update(payload);
                } catch(err) {
                    await getCollection('concenal_config').doc('general').set(payload);
                }
                
                alert("Configurações atualizadas no sistema!");
                document.getElementById('cfg-unsaved-warn').innerText = '';
                closeModal('modal-config');
            } catch(e) {
                alert("Erro ao salvar: " + e.message);
            } finally {
                appData.isProcessing = false;
                document.getElementById('modal-config').classList.remove('opacity-50', 'pointer-events-none');
            }
        }

        // --- LOGIC V29 ---
        function calculateStatus(d, subjName) {
            let sum = 0, filled = 0;
            if(d.units && Array.isArray(d.units)) {
                d.units.forEach(u => { if (u !== null && u !== "") { sum += parseFloat(u); filled++; } });
            }
            let avg = filled > 0 ? (sum / filled).toFixed(1) : '-';
            if (filled === 6) avg = (sum / 6).toFixed(1);

            const totalFaults = countFaults(d);
            const totalDays = SUBJECT_DAYS[subjName] || SUBJECT_DAYS['default'];
            const freqPercent = ((totalDays - totalFaults) / totalDays) * 100;
            
            let st = "Cursando", cl = "status-badge bg-blue-100 text-blue-800";
            
            if(filled >= 3) {
                const numAvg = parseFloat(avg);
                const rVal = (d.recovery !== null && d.recovery !== undefined && d.recovery !== "") ? parseFloat(d.recovery) : null;
                
                if(numAvg < 6.0) { 
                    if(rVal !== null) { 
                        let f = (numAvg + rVal) / 2;
                        if(f >= 6.0) { st = "Aprovado (Rec)"; cl = "status-badge bg-green-100 text-green-800"; }
                        else { st = "Reprovado"; cl = "status-badge bg-red-100 text-red-800"; }
                    } else { st = "Recuperação"; cl = "status-badge bg-orange-100 text-orange-800"; } 
                } else { 
                    st = "Aprovado"; cl = "status-badge bg-green-100 text-green-800"; 
                }
                
                if(freqPercent < 75) { st = "Rep. Faltas"; cl = "status-rf"; }
            }
            return { average:avg, status:st, statusClass:cl, faults:totalFaults, freq:freqPercent.toFixed(1) };
        }

        function countFaults(subData) {
            if(!subData.attendance) return 0;
            return Object.values(subData.attendance).filter(v => {
                if (v === 'F') return true; // Legacy
                if (typeof v === 'object' && v.status === 'F' && !v.justified) return true;
                return false;
            }).length;
        }

        // Login Logic
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value.trim().toLowerCase();
            const p = document.getElementById('password').value.trim();
            const errEl = document.getElementById('login-error');
            errEl.classList.add('hidden');

            try {
                let foundUser = null;
                if (u === "admin" && p === "1234") {
                     foundUser = { id: 'admin_master', name: "Admin Geral", displayName: "Direção Geral", role: "admin", subjects: appData.allSubjects, classes: appData.allClasses };
                } else {
                    const snap = await getCollection('concenal_users').get();
                    const foundDoc = snap.docs.find(doc => {
                        const d = doc.data();
                        return d.username === u && d.password === p;
                    });
                    if (foundDoc) {
                        foundUser = { id: foundDoc.id, ...foundDoc.data() };
                    }
                }

                if (foundUser) {
                    currentUser = foundUser;
                    localStorage.setItem('concenal_v29_session', JSON.stringify(currentUser));
                    showApp();
                } else {
                    throw new Error("Invalid credentials");
                }
            } catch (error) {
                console.error(error);
                errEl.classList.remove('hidden');
            }
        });

        function logout() { localStorage.removeItem('concenal_v29_session'); location.reload(); }

        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('user-display-name').innerText = currentUser.displayName || currentUser.name;

            const isParent = currentUser.role === 'parent';
            const isAdmin = currentUser.role === 'admin';
            const isCoord = currentUser.role === 'coord';

            document.getElementById('btn-admin').classList.toggle('hidden', !isAdmin);
            document.getElementById('btn-coord').classList.toggle('hidden', !isAdmin && !isCoord);
            document.getElementById('btn-config').classList.toggle('hidden', !isAdmin);
            
            const btnNotif = document.getElementById('btn-notifications');
            if (btnNotif) btnNotif.classList.toggle('hidden', !isAdmin && !isCoord);

            const btnChat = document.getElementById('btn-chat');
            if (btnChat) btnChat.classList.toggle('hidden', isParent);
            
            const classTabs = document.getElementById('class-tabs');
            if(isParent) {
                classTabs.innerHTML = '<span class="text-sm font-bold text-gray-500 p-2 uppercase tracking-wide border rounded-lg bg-gray-50 ml-2">Área do Responsável</span>';
                document.getElementById('class-select').parentElement.classList.add('hidden');
            } else {
                classTabs.innerHTML = '';
                document.getElementById('class-select').parentElement.classList.remove('hidden');
            }

            if (currentUser.id === 'admin_master') {
                 loadParentSubjectsAndPopulate();
                 startRealtimeSync();
            } else {
                 if (userProfileUnsubscribe) userProfileUnsubscribe();
                 userProfileUnsubscribe = getCollection('concenal_users').doc(currentUser.id).onSnapshot(doc => {
                     if (doc.exists) {
                         currentUser = { id: doc.id, ...doc.data() };
                         localStorage.setItem('concenal_v29_session', JSON.stringify(currentUser));
                         
                         loadParentSubjectsAndPopulate();
                     } else {
                         logout();
                     }
                 });
                 startRealtimeSync();
            }
        }

        // --- NOTIFICATION SYNC ---
        function listenForNotifications() {
            if (currentUser.role !== 'admin' && currentUser.role !== 'coord') return;
            
            if (notificationsUnsubscribe) notificationsUnsubscribe();
            
            // Limit to last 50 for performance
            notificationsUnsubscribe = getCollection('concenal_notifications').orderBy('timestamp', 'desc').limit(50).onSnapshot(snap => {
                const list = document.getElementById('notifications-list');
                if(!list) return;
                
                list.innerHTML = '';
                let newCount = 0;
                const now = Date.now();

                snap.forEach(doc => {
                    const n = doc.data();
                    const dateStr = new Date(n.timestamp).toLocaleString('pt-BR');
                    
                    // Simple logic: if less than 1 hour old, consider it "new" for the badge pulse
                    if (now - n.timestamp < 3600000) newCount++;

                    let icon = 'fa-info-circle';
                    let color = 'text-blue-500';
                    if (n.type === 'Chamada') { icon = 'fa-user-check'; color = 'text-green-500'; }
                    if (n.type === 'Diário') { icon = 'fa-book'; color = 'text-orange-500'; }
                    if (n.type === 'Atividade') { icon = 'fa-file-pdf'; color = 'text-red-500'; }

                    list.innerHTML += `
                        <div class="bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
                            <div class="flex items-center gap-2 mb-1">
                                <i class="fas ${icon} ${color}"></i>
                                <span class="text-[10px] font-bold uppercase text-gray-500">${n.type}</span>
                                <span class="text-[9px] text-gray-400 ml-auto">${dateStr}</span>
                            </div>
                            <p class="text-xs text-gray-700 leading-tight"><b>${n.teacherName}</b> (${n.subjectName} - ${n.className}): ${n.description}</p>
                        </div>
                    `;
                });

                if (snap.empty) {
                    list.innerHTML = '<div class="text-center text-xs text-gray-400 p-4">Nenhuma atividade recente.</div>';
                }

                const badge = document.getElementById('notif-badge');
                if(badge) {
                    if(newCount > 0) badge.classList.remove('hidden');
                    else badge.classList.add('hidden');
                }
            });
        }

        function startRealtimeSync() {
            document.getElementById('loading-overlay').classList.remove('hidden');
            if (unsubscribe) unsubscribe();
            unsubscribe = getCollection('concenal_students').onSnapshot(snap => {
                const list = [];
                snap.forEach(doc => {
                    const data = doc.data();
                    if (currentUser && currentUser.role === 'parent') {
                        if (data.studentId === currentUser.studentId || doc.id === currentUser.studentId) { 
                            list.push({id: doc.id, ...data});
                            if (!appData.currentClass) appData.currentClass = data.class;
                        }
                    } else {
                        list.push({id: doc.id, ...data});
                    }
                });
                appData.students = list;
                
                if (currentUser && currentUser.role === 'parent') {
                    loadParentSubjectsAndPopulate();
                } else {
                    updateUI();
                }
                
                document.getElementById('loading-overlay').classList.add('hidden');
            }, error => {
                console.error("Firestore sync error:", error);
                document.getElementById('loading-overlay').classList.add('hidden');
            });

            if (activitiesUnsubscribe) activitiesUnsubscribe();
            activitiesUnsubscribe = getCollection('concenal_activities').onSnapshot(snap => {
                let acts = [];
                snap.forEach(doc => acts.push({ id: doc.id, ...doc.data() }));
                appData.activities = acts;
                if(appData.currentMode === 'activities') renderActivitiesView();
            });

            // Start Notification Sync
            listenForNotifications();

            // CHAT SYNC
            getCollection('concenal_chat').onSnapshot(snap => {
                if(currentUser && currentUser.role === 'parent') return; 
                
                let messages = [];
                let newMessagesArrived = false;

                snap.forEach(doc => {
                    const m = doc.data();
                    const docId = doc.id;
                    messages.push({ docId, ...m });
                    
                    if (!isFirstChatLoad && !knownMessages.has(docId)) {
                        const isForMe = (m.to === 'global' || m.to === currentUser?.id || currentUser?.role === 'admin' || currentUser?.role === 'coord');
                        const isFromMe = m.from === currentUser?.id;
                        
                        if (isForMe && !isFromMe) {
                            newMessagesArrived = true;
                            const senderId = m.to === 'global' ? 'global' : m.from;
                            
                            const isChatModalOpen = !document.getElementById('modal-chat').classList.contains('hidden');
                            if (!isChatModalOpen || chatRecipient !== senderId) {
                                showToast(`Nova mensagem de ${m.fromName}`, m.text || "Anexo enviado");
                                unreadCounts[senderId] = (unreadCounts[senderId] || 0) + 1;
                                updateUnreadBadges();
                            }
                        }
                    }
                    knownMessages.add(docId);
                });

                if (newMessagesArrived) playSound();
                isFirstChatLoad = false;

                messages.sort((a, b) => a.timestamp - b.timestamp);
                const allMessages = messages.slice(-200); 

                renderChatMessages(allMessages);
            });
        }
        
        function renderChatMessages(allMessages) {
            const div = document.getElementById('chat-messages');
            if(!div) return;
            div.innerHTML = '';
            
            currentChatMessages = allMessages.filter(m => {
                if (chatRecipient === 'global') return m.to === 'global';
                return (m.from === currentUser?.id && m.to === chatRecipient) || 
                       (m.to === currentUser?.id && m.from === chatRecipient);
            });

            currentChatMessages.forEach(m => {
                const isSent = m.from === currentUser?.id;
                const date = new Date(m.timestamp).toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                let fH = '';
                if(m.file) {
                     if(m.file.type.startsWith('image')) fH = `<img src="${m.file.data}" class="max-h-48 rounded-lg mb-2 shadow-sm cursor-pointer" onclick="viewDoc('${m.file.data}')">`;
                     else fH = `<a href="${m.file.data}" download="${m.file.name}" class="bg-black bg-opacity-5 p-2 rounded-lg block text-[10px] border border-black border-opacity-5 mb-2"><i class="fas fa-file-alt mr-1"></i> ${m.file.name}</a>`;
                }

                const isAdminOrCoord = (currentUser?.role === 'admin' || currentUser?.role === 'coord');
                const isTeacher = currentUser?.role === 'teacher';
                
                const canDelete = isAdminOrCoord;
                const canReqDelete = isTeacher && isSent && m.to !== 'global' && !m.deleteRequested;
                
                let reqDelHtml = canReqDelete ? `<button onclick="requestDeleteMsg('${m.docId}')" class="text-[9px] text-orange-500 hover:text-orange-700 transition mt-1 block w-full text-right uppercase font-bold"><i class="fas fa-exclamation-triangle"></i> Pedir Exclusão</button>` : '';
                let badgeHtml = m.deleteRequested ? `<div class="absolute -top-2 -left-2 bg-red-500 text-white text-[8px] px-2 py-0.5 rounded-full shadow-sm animate-pulse border border-white font-bold tracking-widest z-10">EXCLUSÃO SOLICITADA</div>` : '';
                let delBtnHtml = canDelete ? `<button onclick="deleteMsg('${m.docId}')" class="absolute -top-2 -right-2 text-red-500 bg-white rounded-full opacity-0 group-hover:opacity-100 transition z-10 w-6 h-6 flex items-center justify-center shadow-md border border-gray-100 hover:bg-red-50"><i class="fas fa-times"></i></button>` : '';

                const extraBorder = m.deleteRequested ? "border-2 border-red-400" : (isSent ? "border border-green-200" : "border border-gray-200");

                div.innerHTML += `
                    <div class="chat-msg ${isSent?'sent':'received'} p-3 shadow-sm group ${extraBorder}">
                        ${badgeHtml}
                        <div class="text-[8px] font-bold text-gray-500 uppercase tracking-tighter mb-1">${m.fromName} ${m.to === 'global' ? '• MURAL' : ''}</div>
                        ${fH}
                        <div class="text-xs leading-relaxed text-gray-800 break-words">${m.text}</div>
                        <div class="text-[7px] text-right mt-1 opacity-40 font-bold">${date}</div>
                        ${reqDelHtml}
                        ${delBtnHtml}
                    </div>
                `;
            });
            div.scrollTop = div.scrollHeight;
        }

        function updateUI() {
            if (!currentUser) return; 

            const cs = document.getElementById('class-select');
            if(cs && cs.value !== appData.currentClass && currentUser.role !== 'parent') {
                 cs.value = appData.currentClass;
            }

            // Tabs UI update
            ['nav-grades','nav-attendance','nav-daily', 'nav-activities'].forEach(id => {
                const el = document.getElementById(id);
                if(!el) return;
                const isActive = `nav-${appData.currentMode}` === id;
                if(isActive) {
                    el.classList.add('border-school-green', 'text-school-green');
                    el.classList.remove('border-transparent', 'text-gray-500');
                } else {
                    el.classList.remove('border-school-green', 'text-school-green');
                    el.classList.add('border-transparent', 'text-gray-500');
                }
            });

            ['view-grades', 'view-attendance', 'view-daily', 'view-activities'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            
            const activeView = document.getElementById(`view-${appData.currentMode}`);
            if (activeView) activeView.classList.remove('hidden');

            if (appData.currentMode === 'grades') renderGradesTable();
            else if (appData.currentMode === 'attendance') renderAttendanceTable();
            else if (appData.currentMode === 'daily') loadDailyData();
            else if (appData.currentMode === 'activities') renderActivitiesView();
        }

        function getStudentsByClass() {
            if (currentUser && currentUser.role === 'parent') return appData.students;
            return appData.students.filter(s => s.class === appData.currentClass).sort((a,b) => a.name.localeCompare(b.name));
        }

        function ensureSubjectData(student, subject) {
            if (!student.subjects) student.subjects = {};
            if (!student.subjects[subject]) {
                student.subjects[subject] = { units: [null,null,null,null,null,null], attendance: {}, dailyLogs: {}, recovery: null, observations: [] };
            } else {
                const d = student.subjects[subject];
                if (!d.units || !Array.isArray(d.units)) d.units = [null,null,null,null,null,null];
                if (!d.attendance) d.attendance = {};
                if (!d.dailyLogs) d.dailyLogs = {};
                if (!d.observations) d.observations = [];
            }
            return student.subjects[subject];
        }

        // --- RENDER VIEWS ---
        function renderGradesTable() {
            // Professor SÓ edita se a turma X for atribuída à matéria Y dele. Admin edita tudo.
            const canEdit = currentUser && (
                currentUser.role === 'admin' || 
                (currentUser.role === 'teacher' && 
                 currentUser.assignments && 
                 currentUser.assignments[appData.currentSubject] && 
                 currentUser.assignments[appData.currentSubject].includes(appData.currentClass))
            ); 
            
            const readOnlyMsg = document.getElementById('read-only-msg');
            if (readOnlyMsg) readOnlyMsg.classList.toggle('hidden', canEdit || (currentUser && currentUser.role === 'parent'));
            
            const btnContainer = document.getElementById('action-buttons');
            if (btnContainer) {
                btnContainer.innerHTML = canEdit ? `<button onclick="openAddModal()" class="bg-school-green text-white px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase shadow-sm">Novo Aluno</button><button onclick="document.getElementById('modal-import').classList.remove('hidden')" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase shadow-sm">Importar Massa</button>` : '';
            }

            const tbody = document.getElementById('grades-body'); 
            if(!tbody) return;
            tbody.innerHTML = '';
            
            const list = getStudentsByClass();
            const emptyState = document.getElementById('empty-state');
            
            if(list.length === 0 || (!appData.currentClass && currentUser.role !== 'parent') || !appData.currentSubject) { 
                if (emptyState) emptyState.classList.remove('hidden'); 
                return; 
            }
            if (emptyState) emptyState.classList.add('hidden');

            list.forEach(s => {
                const d = ensureSubjectData(s, appData.currentSubject); const c = calculateStatus(d, appData.currentSubject);
                let row = `<tr class="hover:bg-gray-50 transition border-b border-gray-100"><td class="px-4 py-4 border-r flex justify-between items-center sticky left-0 bg-white"><div><span class="font-bold text-gray-700">${s.name}</span><br><span class="text-[9px] text-gray-300 font-mono text-left block w-20 truncate">${s.id}</span></div><div class="flex gap-2"><button onclick="openReportModal('${s.id}')" class="text-blue-500 hover:scale-110 transition"><i class="fas fa-file-alt"></i></button>${canEdit?`<button onclick="deleteStudent('${s.id}')" class="text-red-300 hover:text-red-500 transition"><i class="fas fa-trash"></i></button>`:''}</div></td>`;
                for(let i=0; i<6; i++) { 
                    const v = d.units[i] ?? ''; 
                    row += `<td class="px-1 border-l"><input type="number" step="0.1" ${!canEdit?'disabled':''} class="w-full text-center bg-transparent focus:outline-none ${v!==''&&v<6?'text-red-600 font-bold':'text-green-700'}" value="${v}" onchange="updateGrade('${s.id}',${i},this.value)"></td>`; 
                }
                row += `<td class="px-1 text-center font-bold border-l cursor-pointer ${c.freq<75?'text-red-700 bg-red-50':'text-blue-800'}" onclick="openReportModal('${s.id}')">${c.faults} <span class="text-[8px] font-normal opacity-40">${c.freq}%</span></td><td class="px-2 text-center font-bold border-l text-gray-700">${c.average}</td><td class="px-1 border-l"><input type="number" step="0.1" ${!canEdit?'disabled':''} class="w-full text-center bg-gray-50" value="${d.recovery||''}" onchange="updateRecovery('${s.id}',this.value)"></td><td class="px-2 text-center border-l"><span class="${c.statusClass}">${c.status||'--'}</span></td></tr>`;
                tbody.innerHTML += row;
            });
        }

        function renderAttendanceTable(){
            const dateInput = document.getElementById('attendance-date');
            if(!dateInput) return;
            const date = dateInput.value; 
            const canE = currentUser && (
                currentUser.role === 'admin' || 
                (currentUser.role === 'teacher' && 
                 currentUser.assignments && 
                 currentUser.assignments[appData.currentSubject] && 
                 currentUser.assignments[appData.currentSubject].includes(appData.currentClass))
            ); 
            const students = getStudentsByClass();
            
            const actionsContainer = document.getElementById('attendance-actions');
            if (actionsContainer) {
                // SÓ quem pode editar a chamada vê o botão de salvar. O botão de PDF todos podem ver.
                actionsContainer.innerHTML = `
                    <button onclick="openReportsModal('attendance')" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-gray-100 transition flex items-center gap-2"><i class="fas fa-print"></i> Relatório PDF</button>
                    ${canE ? `<button onclick="saveDailyAttendance()" class="bg-school-green text-white px-6 py-2 rounded-lg text-sm font-bold shadow hover:bg-green-700 transition flex items-center gap-2"><i class="fas fa-save"></i> Salvar Chamada</button>` : ''}
                `;
            }

            // Render History Strip
            let savedDates = new Set();
            students.forEach(s => {
                const sub = ensureSubjectData(s, appData.currentSubject);
                if(sub.attendance) Object.keys(sub.attendance).forEach(d => savedDates.add(d));
            });
            const strip = document.getElementById('attendance-history-strip');
            if(strip) {
                strip.innerHTML = '';
                Array.from(savedDates).sort((a,b) => b.localeCompare(a)).forEach(d => {
                    const isSelected = d === date;
                    const fmtDate = d.split('-').reverse().join('/');
                    strip.innerHTML += `<button onclick="changeAttendanceDate('${d}')" class="px-3 py-1.5 rounded-lg text-[10px] font-bold border whitespace-nowrap transition ${isSelected ? 'bg-school-green text-white border-school-green' : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50'}">${fmtDate}</button>`;
                });
                if(savedDates.size === 0) strip.innerHTML = '<span class="text-[10px] text-gray-400 italic py-1.5">Nenhum registro encontrado para esta matéria/turma.</span>';
            }

            const tbody=document.getElementById('attendance-body'); 
            if(!tbody) return;
            tbody.innerHTML=''; 
            
            if(!appData.currentSubject) return;

            students.forEach(s=>{
                const sub=ensureSubjectData(s, appData.currentSubject); const r=sub.attendance[date]; 
                
                // Extract teacher tracking info if available
                let tName = '';
                let st='P', j=false, doc=null; 
                if(r){ 
                    if(typeof r==='string') {
                        st=r; 
                    } else {
                        st=r.status; 
                        j=r.justified; 
                        doc=r.doc;
                        tName = r.teacherName ? `Registrado por: ${r.teacherName}` : '';
                    } 
                }
                
                tempAttendance[s.id] = r || { status: 'P', teacherId: currentUser.id, teacherName: currentUser.displayName || currentUser.name };
                
                let btnCls = st==='P'?"bg-green-100 text-green-800 border-green-200": (j?"bg-blue-100 text-blue-800 border-blue-200":"bg-red-100 text-red-800 border-red-200");
                let btnTxt = st==='P'?"PRESENTE": (j?"JUSTIFICADO":"FALTOU");
                
                let act = (st === 'F' && currentUser && currentUser.role === 'parent') ? 
                    `<button onclick="openJustifyModal('${s.id}')" class="ml-2 text-[10px] text-blue-600 underline font-bold uppercase tracking-tighter">Justificar</button>` : 
                    ((j && doc) ? `<button onclick="viewDoc('${doc}')" class="ml-2 text-blue-500 hover:scale-110 transition"><i class="fas fa-paperclip"></i></button>` : '');
                
                let infoHtml = tName ? `<div class="text-[8px] text-gray-400 font-normal uppercase tracking-tighter mt-1">${tName}</div>` : '';

                tbody.innerHTML += `<tr class="border-b border-gray-50"><td class="px-6 py-4 font-bold text-gray-700 flex justify-between items-center">${s.name} ${act}</td><td class="px-6 py-4 text-center"><button id="btn-att-${s.id}" onclick="toggleAtt('${s.id}')" ${!canE?'disabled':''} class="w-32 py-2 rounded-lg shadow-sm text-[10px] font-bold border uppercase transition flex flex-col items-center justify-center ${btnCls} mx-auto"><span>${btnTxt}</span></button>${infoHtml}</td></tr>`;
            });
        }
        
        function changeAttendanceDate(dateStr) {
            document.getElementById('attendance-date').value = dateStr;
            renderAttendanceTable();
        }

        function loadDailyData() {
            const dateInput = document.getElementById('daily-date');
            if(!dateInput) return;
            const date = dateInput.value;
            tempDaily = {}; 
            
            // Daily Log History Strip
            const students = getStudentsByClass();
            let savedDates = new Set();
            students.forEach(s => {
                const sub = ensureSubjectData(s, appData.currentSubject);
                if(sub.dailyLogs) Object.keys(sub.dailyLogs).forEach(d => savedDates.add(d));
            });
            const strip = document.getElementById('daily-history-strip');
            if(strip) {
                strip.innerHTML = '';
                Array.from(savedDates).sort((a,b) => b.localeCompare(a)).forEach(d => {
                    const isSelected = d === date;
                    const fmtDate = d.split('-').reverse().join('/');
                    strip.innerHTML += `<button onclick="changeDailyDate('${d}')" class="px-3 py-1.5 rounded-lg text-[10px] font-bold border whitespace-nowrap transition ${isSelected ? 'bg-school-green text-white border-school-green' : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50'}">${fmtDate}</button>`;
                });
                if(savedDates.size === 0) strip.innerHTML = '<span class="text-[10px] text-gray-400 italic py-1.5">Nenhum diário salvo.</span>';
            }


            getStudentsByClass().forEach(s => {
                const sub = ensureSubjectData(s, appData.currentSubject);
                const l = (sub.dailyLogs || {})[date] || { homework: false, behavior: 'Normal', note: '', teacherName: '' };
                tempDaily[s.id] = { ...l };
            });
            renderDailyTable();
        }

        function changeDailyDate(dateStr) {
            document.getElementById('daily-date').value = dateStr;
            loadDailyData();
        }

        function renderDailyTable() {
            const tbody = document.getElementById('daily-body'); 
            if(!tbody) return;
            tbody.innerHTML = '';
            
            const canE = currentUser && (
                currentUser.role === 'admin' || 
                (currentUser.role === 'teacher' && 
                 currentUser.assignments && 
                 currentUser.assignments[appData.currentSubject] && 
                 currentUser.assignments[appData.currentSubject].includes(appData.currentClass))
            ); 
            
            const actionsContainer = document.getElementById('daily-actions');
            if (actionsContainer) {
                actionsContainer.innerHTML = `
                    <button onclick="openReportsModal('daily')" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-gray-100 transition flex items-center gap-2"><i class="fas fa-print"></i> Relatório PDF</button>
                    ${canE ? `<button onclick="saveDailyLog()" class="bg-blue-600 text-white px-6 py-2 rounded-lg text-sm font-bold shadow hover:bg-blue-700 transition flex items-center gap-2"><i class="fas fa-book"></i> Gravar Diário</button>` : ''}
                `;
            }

            if(!appData.currentSubject) return;

            getStudentsByClass().forEach(s => {
                const l = tempDaily[s.id] || { homework: false, behavior: 'Normal', note: '' };
                let tInfo = l.teacherName ? `<div class="text-[8px] text-gray-400 font-bold uppercase mt-1">Por: ${l.teacherName}</div>` : '';
                
                tbody.innerHTML += `<tr class="border-b border-gray-50">
                    <td class="px-4 py-4 text-gray-700 font-bold">${s.name} ${tInfo}</td>
                    <td class="px-2 py-4 text-center">
                        <button id="btn-hw-${s.id}" onclick="toggleHw('${s.id}')" ${!canE?'disabled':''} class="w-8 h-8 rounded-full shadow-inner transition ${l.homework ? 'bg-green-500 text-white shadow-lg' : 'bg-gray-100 text-gray-300'}">
                            <i class="fas fa-home"></i>
                        </button>
                    </td>
                    <td class="px-2 py-4 text-center">
                        <select onchange="updateBehavior('${s.id}', this.value)" ${!canE?'disabled':''} class="border border-gray-100 rounded-lg text-xs p-1.5 font-bold bg-gray-50 outline-none">
                            <option ${l.behavior==='Normal'?'selected':''}>Normal</option>
                            <option ${l.behavior==='Excelente'?'selected':''}>Excelente</option>
                            <option ${l.behavior==='Ruim'?'selected':''}>Ruim</option>
                        </select>
                    </td>
                    <td class="px-2 py-4 text-center">
                        <input type="text" value="${l.note || ''}" onchange="updateDailyNote('${s.id}', this.value)" ${!canE?'disabled':''} class="border border-gray-100 rounded-lg text-xs p-1.5 bg-gray-50 outline-none w-full" placeholder="...">
                    </td>
                </tr>`;
            });
        }

        function renderActivitiesView() {
            const canEdit = currentUser && (
                currentUser.role === 'admin' || 
                (currentUser.role === 'teacher' && 
                 currentUser.assignments && 
                 currentUser.assignments[appData.currentSubject] && 
                 currentUser.assignments[appData.currentSubject].includes(appData.currentClass))
            ); 

            const btnNewAct = document.getElementById('btn-new-activity');
            if (btnNewAct) btnNewAct.classList.toggle('hidden', !canEdit);

            const listEl = document.getElementById('activities-list');
            if(!listEl) return;
            listEl.innerHTML = '';

            const filteredActs = appData.activities.filter(a => a.class === appData.currentClass && a.subject === appData.currentSubject);
            
            if(filteredActs.length === 0) {
                listEl.innerHTML = `<div class="col-span-full p-12 text-center text-gray-400">
                    <i class="fas fa-file-pdf text-4xl mb-3 opacity-50"></i>
                    <p class="text-xs uppercase tracking-widest font-bold">Nenhum material cadastrado</p>
                </div>`;
                return;
            }

            filteredActs.sort((a,b) => b.timestamp - a.timestamp).forEach(act => {
                const date = new Date(act.timestamp).toLocaleDateString('pt-BR');
                listEl.innerHTML += `
                    <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 flex flex-col justify-between hover:shadow-md transition">
                        <div>
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold text-gray-800 text-sm leading-tight pr-2">${act.title}</h4>
                                <i class="fas fa-file-pdf text-red-500 text-xl"></i>
                            </div>
                            <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wide mb-4">Enviado por ${act.teacherName} • ${date}</p>
                        </div>
                        <div class="flex gap-2">
                            <a href="${act.fileData}" download="${act.fileName}" class="flex-1 bg-blue-600 text-white text-center py-2 rounded-lg text-xs font-bold shadow hover:bg-blue-700 transition">Baixar PDF</a>
                            ${canEdit ? `<button onclick="deleteActivity('${act.id}')" class="bg-red-100 text-red-600 px-3 rounded-lg hover:bg-red-200 transition"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </div>
                `;
            });
        }

        // --- ATIVIDADES PDF ACTIONS ---
        function openSendActivityModal() {
            document.getElementById('act-title').value = '';
            document.getElementById('act-file').value = '';
            currentActivityFile = null;
            document.getElementById('act-file-name').innerText = 'Clique ou arraste o PDF aqui';
            document.getElementById('act-class-display').innerText = appData.currentClass;
            document.getElementById('act-subj-display').innerText = appData.currentSubject;
            document.getElementById('modal-send-activity').classList.remove('hidden');
        }

        function previewActivityFile(input) {
            const file = input.files[0];
            if (!file) return;
            if (file.type !== 'application/pdf') return alert("Apenas arquivos PDF são permitidos.");
            if (file.size > 800 * 1024) {
                input.value = '';
                return alert("O arquivo excede o limite de 800KB. Compacte o PDF antes de enviar.");
            }
            document.getElementById('act-file-name').innerText = file.name;
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = e => {
                currentActivityFile = { name: file.name, data: e.target.result };
            };
        }

        async function submitActivity() {
            const title = document.getElementById('act-title').value.trim();
            if(!title || !currentActivityFile) return alert("Preencha o título e selecione um arquivo PDF.");
            
            try {
                await getCollection('concenal_activities').add({
                    class: appData.currentClass,
                    subject: appData.currentSubject,
                    title: title,
                    fileName: currentActivityFile.name,
                    fileData: currentActivityFile.data,
                    teacherName: currentUser.displayName || currentUser.name,
                    teacherId: currentUser.id,
                    timestamp: Date.now()
                });
                
                logAction('Atividade', `Disponibilizou o arquivo: ${title}`);
                closeModal('modal-send-activity');
                alert("Atividade enviada com sucesso!");
            } catch(e) {
                console.error(e);
                alert("Erro ao enviar atividade: " + e.message);
            }
        }

        function deleteActivity(id) {
            if(confirm("Remover esta atividade para todos os alunos?")) {
                getCollection('concenal_activities').doc(id).delete();
            }
        }

        // --- ACTIONS ---
        function toggleAtt(id) { 
            let c = tempAttendance[id];
            let st = typeof c === 'string' ? c : c.status;
            let nw = st === 'P' ? 'F' : 'P';
            
            // Sempre que altera, atribui a posse da alteração
            tempAttendance[id] = {
                status: nw,
                teacherId: currentUser.id,
                teacherName: currentUser.displayName || currentUser.name,
                timestamp: Date.now()
            };

            const btn = document.getElementById(`btn-att-${id}`);

            if (nw === 'P') {
                btn.className = "w-32 py-2 rounded-lg shadow-sm text-[10px] font-bold border uppercase transition flex flex-col items-center justify-center bg-green-100 text-green-800 border-green-200 mx-auto";
                btn.innerHTML = "<span>PRESENTE</span>";
            } else {
                btn.className = "w-32 py-2 rounded-lg shadow-sm text-[10px] font-bold border uppercase transition flex flex-col items-center justify-center bg-red-100 text-red-800 border-red-200 mx-auto";
                btn.innerHTML = "<span>FALTOU</span>";
            }
        }

        function toggleHw(id){ 
            if (tempDaily[id]) { 
                tempDaily[id].homework = !tempDaily[id].homework; 
                tempDaily[id].teacherName = currentUser.displayName || currentUser.name;
                renderDailyTable(); 
            } 
        }
        function updateBehavior(id,v){ 
            tempDaily[id].behavior=v; 
            tempDaily[id].teacherName = currentUser.displayName || currentUser.name;
        }
        function updateDailyNote(id, v) {
            tempDaily[id].note = v;
            tempDaily[id].teacherName = currentUser.displayName || currentUser.name;
        }
        
        async function saveDailyAttendance(){ 
            const d=document.getElementById('attendance-date').value; let b=db.batch(); 
            getStudentsByClass().forEach(s=>{ 
                const sub=ensureSubjectData(s, appData.currentSubject); 
                sub.attendance[d]=tempAttendance[s.id]; 
                b.set(getCollection('concenal_students').doc(s.id), {subjects:{[appData.currentSubject]:{attendance:sub.attendance}}},{merge:true}); 
            }); 
            await b.commit(); 
            logAction('Chamada', `Realizou a chamada do dia ${d.split('-').reverse().join('/')}`);
            alert("Chamada salva!"); 
            renderAttendanceTable(); 
        }

        async function saveDailyLog(){ 
            const d=document.getElementById('daily-date').value; let b=db.batch(); 
            getStudentsByClass().forEach(s=>{ 
                const sub=ensureSubjectData(s, appData.currentSubject); 
                sub.dailyLogs[d]=tempDaily[s.id]; 
                b.set(getCollection('concenal_students').doc(s.id), {subjects:{[appData.currentSubject]:{dailyLogs:sub.dailyLogs}}},{merge:true}); 
            }); 
            await b.commit(); 
            logAction('Diário', `Registrou o diário de bordo do dia ${d.split('-').reverse().join('/')}`);
            alert("Diário atualizado!"); 
            loadDailyData();
        }

        function updateGrade(id,i,v){ const s=appData.students.find(x=>x.id===id); const sd=ensureSubjectData(s,appData.currentSubject); sd.units[i]=v; getCollection('concenal_students').doc(id).set({subjects:{[appData.currentSubject]:{units:sd.units}}},{merge:true}); }
        function updateRecovery(id,v){ const s=appData.students.find(x=>x.id===id); getCollection('concenal_students').doc(id).set({subjects:{[appData.currentSubject]:{recovery:v}}},{merge:true}); }
        function deleteStudent(id){ if(confirm("Remover aluno?")) getCollection('concenal_students').doc(id).delete(); }
        function addStudent(){ const n=document.getElementById('new-name').value; if(!n) return; getCollection('concenal_students').add({name:n, class:appData.currentClass, subjects:{}}); closeModal('modal-add'); }
        async function importStudents(){ const l=document.getElementById('import-list').value.split('\n'); let b=db.batch(); l.forEach(n=>{ if(n.trim()) b.set(getCollection('concenal_students').doc(),{name:n.trim(),class:appData.currentClass,subjects:{}}); }); await b.commit(); closeModal('modal-import'); }

        // --- RELATÓRIOS PDF NATIVOS ---
        function openReportsModal(type) {
            document.getElementById('report-type-input').value = type;
            const title = type === 'attendance' ? 'Relatório de Frequência' : 'Relatório Diário de Bordo';
            document.getElementById('reports-modal-title').innerText = title;
            
            // Carregar lista de alunos da turma atual
            const stSelect = document.getElementById('report-student');
            stSelect.innerHTML = '<option value="all">Todos os Alunos</option>';
            getStudentsByClass().forEach(s => {
                stSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
            });

            document.getElementById('modal-reports').classList.remove('hidden');
        }

        function generateFilteredPDF() {
            const type = document.getElementById('report-type-input').value; // 'attendance' or 'daily'
            const period = document.getElementById('report-period').value;
            const studentId = document.getElementById('report-student').value;
            const printArea = document.getElementById('print-area');
            
            let studentsToPrint = getStudentsByClass();
            if(studentId !== 'all') {
                studentsToPrint = studentsToPrint.filter(s => s.id === studentId);
            }

            const now = new Date();
            let dateFilterFn = (dStr) => true; // 'all'
            if(period === 'today') {
                const td = now.toISOString().split('T')[0];
                dateFilterFn = (dStr) => dStr === td;
            } else if (period === 'month') {
                const tm = now.toISOString().slice(0, 7);
                dateFilterFn = (dStr) => dStr.startsWith(tm);
            } else if (period === 'week') {
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                dateFilterFn = (dStr) => dStr >= weekAgo;
            }

            let html = `
                <div class="text-center mb-6">
                    <h2 class="text-xl font-bold uppercase">Relatório Oficial - CONCENAL</h2>
                    <p class="text-sm">Turma: ${appData.currentClass} | Disciplina: ${appData.currentSubject}</p>
                    <p class="text-xs text-gray-500">Documento gerado em ${now.toLocaleDateString('pt-BR')} às ${now.toLocaleTimeString('pt-BR')}</p>
                </div>
            `;

            if(type === 'attendance') {
                html += `<table class="w-full text-xs text-left border-collapse"><thead class="bg-gray-100 border-b-2 border-gray-800"><tr><th class="p-2 border">Aluno</th><th class="p-2 border">Data</th><th class="p-2 border">Status</th><th class="p-2 border">Professor/Resp.</th></tr></thead><tbody>`;
                studentsToPrint.forEach(s => {
                    const sub = ensureSubjectData(s, appData.currentSubject);
                    if(sub.attendance) {
                        Object.entries(sub.attendance).filter(([d]) => dateFilterFn(d)).sort((a,b) => b[0].localeCompare(a[0])).forEach(([date, att]) => {
                            let st = typeof att === 'string' ? att : att.status;
                            let prof = typeof att === 'object' && att.teacherName ? att.teacherName : '--';
                            let fmtD = date.split('-').reverse().join('/');
                            let displaySt = st === 'P' ? 'Presente' : 'Falta';
                            if(typeof att === 'object' && att.justified) displaySt = 'Falta (Justificada)';
                            html += `<tr><td class="p-2 border font-bold">${s.name}</td><td class="p-2 border">${fmtD}</td><td class="p-2 border">${displaySt}</td><td class="p-2 border">${prof}</td></tr>`;
                        });
                    }
                });
                html += `</tbody></table>`;
            } else {
                html += `<table class="w-full text-xs text-left border-collapse"><thead class="bg-gray-100 border-b-2 border-gray-800"><tr><th class="p-2 border">Aluno</th><th class="p-2 border">Data</th><th class="p-2 border">Dever</th><th class="p-2 border">Comport.</th><th class="p-2 border">Notas</th><th class="p-2 border">Prof.</th></tr></thead><tbody>`;
                studentsToPrint.forEach(s => {
                    const sub = ensureSubjectData(s, appData.currentSubject);
                    if(sub.dailyLogs) {
                        Object.entries(sub.dailyLogs).filter(([d]) => dateFilterFn(d)).sort((a,b) => b[0].localeCompare(a[0])).forEach(([date, l]) => {
                            let fmtD = date.split('-').reverse().join('/');
                            let hw = l.homework ? 'Sim' : 'Não';
                            let prof = l.teacherName || '--';
                            html += `<tr><td class="p-2 border font-bold">${s.name}</td><td class="p-2 border">${fmtD}</td><td class="p-2 border">${hw}</td><td class="p-2 border">${l.behavior}</td><td class="p-2 border">${l.note||'-'}</td><td class="p-2 border">${prof}</td></tr>`;
                        });
                    }
                });
                html += `</tbody></table>`;
            }

            printArea.innerHTML = html;
            closeModal('modal-reports');
            
            // Disparar impressão. O CSS @media print cuida de esconder o resto do site.
            window.print();
        }


        // --- HISTÓRICO ACADÊMICO UNIFICADO (REFACTOR) ---
        function openReportModal(id){
            currentStudentForReport=appData.students.find(s=>s.id===id); if(!currentStudentForReport) return;
            const student = currentStudentForReport;
            document.getElementById('report-name').innerText=student.name; 
            
            const tbody = document.getElementById('unified-report-body');
            tbody.innerHTML = '';
            
            // Identificar quais disciplinas exibir (baseado no currículo da turma)
            let subjectsToDisplay = appData.curriculum[student.class] || [];
            
            // Garantir que disciplinas onde o aluno já tem nota apareçam, mesmo se saírem do currículo
            if (student.subjects) {
                Object.keys(student.subjects).forEach(s => {
                    if (!subjectsToDisplay.includes(s)) subjectsToDisplay.push(s);
                });
            }

            if(subjectsToDisplay.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="p-6 text-gray-400">Nenhum dado cadastrado.</td></tr>';
            }

            let totalAvg = 0, avgCount = 0, totalFaultsGlobal = 0, totalDaysGlobal = 0;

            subjectsToDisplay.sort().forEach(subjName => {
                const d = student.subjects?.[subjName] || { units: [], attendance: {}, recovery: null };
                const c = calculateStatus(d, subjName);

                totalFaultsGlobal += c.faults;
                totalDaysGlobal += SUBJECT_DAYS[subjName] || SUBJECT_DAYS['default'];

                if(c.average !== '-') {
                    totalAvg += parseFloat(c.average);
                    avgCount++;
                }

                let row = `<tr class="hover:bg-gray-50"><td class="px-4 py-3 text-left font-bold border-r">${subjName}</td>`;
                for(let i=0; i<6; i++) {
                    const uVal = d.units?.[i];
                    const vClass = (uVal && uVal < 6) ? 'text-red-500 font-bold' : '';
                    row += `<td class="${vClass}">${uVal !== undefined && uVal !== null ? uVal : '-'}</td>`;
                }
                row += `<td class="border-l font-bold ${c.freq < 75 ? 'text-red-600' : 'text-blue-600'}">${c.faults}</td>`;
                row += `<td class="border-l font-bold text-gray-800">${c.average}</td>`;
                row += `<td class="border-l font-bold text-red-500">${d.recovery || '-'}</td>`;
                row += `<td class="border-l"><span class="${c.statusClass}">${c.status}</span></td></tr>`;
                tbody.innerHTML += row;
            });

            // Resumo Global Topo
            const finalGlobalAvg = avgCount > 0 ? (totalAvg / avgCount).toFixed(1) : '-';
            const finalGlobalFreq = totalDaysGlobal > 0 ? (((totalDaysGlobal - totalFaultsGlobal) / totalDaysGlobal) * 100).toFixed(1) : '-';
            
            document.getElementById('report-avg').innerText = finalGlobalAvg;
            document.getElementById('report-freq').innerText = finalGlobalFreq !== '-' ? finalGlobalFreq + '%' : '-';
            document.getElementById('report-days-count').innerText = `Total Faltas: ${totalFaultsGlobal}`;
            if(finalGlobalFreq !== '-') document.getElementById('report-freq-bar').style.width = finalGlobalFreq + '%';
            
            let globalStatus = "CURSANDO";
            if(finalGlobalAvg !== '-' && finalGlobalAvg >= 6.0 && finalGlobalFreq >= 75) globalStatus = "APROVADO GERAL";
            if(finalGlobalFreq !== '-' && finalGlobalFreq < 75) globalStatus = "REPROVADO POR FALTAS";
            document.getElementById('report-status').innerText = globalStatus;
            
            // Observações (Unificadas)
            const obsList = document.getElementById('observations-list'); 
            obsList.innerHTML = '';
            let allObs = [];
            if(student.subjects) {
                Object.entries(student.subjects).forEach(([subj, data]) => {
                    if(data.observations) {
                        data.observations.forEach(o => allObs.push({subj, ...o}));
                    }
                });
            }

            if(allObs.length === 0) obsList.innerHTML = '<div class="text-xs text-gray-400 italic">Sem pareceres registrados.</div>';

            // Ordena observações por data simulada (Atenção: formato BR dd/mm/yyyy dificulta sort direto, simplificando)
            allObs.reverse().forEach(o => {
                obsList.innerHTML += `<div class="bg-white border border-gray-100 p-3 rounded-xl shadow-sm text-xs"><div class="flex justify-between text-[10px] text-gray-400 font-bold uppercase mb-1"><span><b class="text-school-green">${o.subj}</b> - ${o.date}</span><span>${o.author}</span></div><p class="text-gray-700 leading-relaxed">${o.text}</p></div>`;
            });
            
            const isP = currentUser && currentUser.role === 'parent'; 
            document.getElementById('report-tools').classList.toggle('hidden', isP || !appData.currentSubject); 
            document.getElementById('obs-subject-label').innerText = appData.currentSubject || '';
            document.getElementById('report-parent-msg').classList.toggle('hidden', !isP); 
            document.getElementById('modal-report').classList.remove('hidden');
        }

        async function addObservation(){ 
            const t = document.getElementById('new-observation-text').value; 
            const d = document.getElementById('new-observation-date').value;
            if(!t || !appData.currentSubject) return;
            const s = currentStudentForReport;
            const sd = ensureSubjectData(s, appData.currentSubject);
            sd.observations.push({date: d.split('-').reverse().join('/'), text: t, author: currentUser.displayName || currentUser.name});
            await getCollection('concenal_students').doc(s.id).set({subjects:{[appData.currentSubject]:{observations:sd.observations}}},{merge:true});
            document.getElementById('new-observation-text').value = ''; 
            openReportModal(s.id);
        }

        function printUnifiedReport() {
            // Reaproveitar lógica do print area
            const printArea = document.getElementById('print-area');
            const student = currentStudentForReport;
            const now = new Date();
            
            let html = `
                <div class="text-center mb-6 border-b pb-4">
                    <h2 class="text-2xl font-bold uppercase">Boletim Escolar Unificado - CONCENAL</h2>
                    <p class="text-lg font-bold mt-2">Aluno(a): ${student.name}</p>
                    <p class="text-sm">Turma: ${student.class} | Ano Letivo: ${now.getFullYear()}</p>
                </div>
            `;
            
            // Copia a tabela exata que já foi renderizada no modal
            const tableHTML = document.querySelector('#modal-report table').outerHTML;
            html += tableHTML;

            // Observações
            html += `<h3 class="text-sm font-bold uppercase mt-8 border-b pb-2 mb-4">Pareceres Pedagógicos</h3>`;
            const obsItems = document.querySelectorAll('#observations-list div.bg-white');
            if(obsItems.length === 0) html += '<p class="text-xs italic text-gray-500">Nenhum parecer registrado.</p>';
            obsItems.forEach(el => {
                html += `<div class="mb-4 text-xs"><div class="font-bold border-b pb-1 mb-1">${el.querySelector('.flex span').innerText}</div><p>${el.querySelector('p').innerText}</p></div>`;
            });

            printArea.innerHTML = html;
            window.print();
        }

        function openJustifyModal(sid){
            currentJustificationStudentId = sid;
            currentJustificationDate = document.getElementById('attendance-date').value;
            document.getElementById('just-date-display').innerText = `${currentJustificationDate.split('-').reverse().join('/')} - ${appData.currentSubject}`;
            document.getElementById('modal-justification').classList.remove('hidden');
        }

        async function submitJustification() {
            const f = document.getElementById('just-file').files[0];
            const reason = document.getElementById('just-reason').value;
            
            const save = (b64) => {
                const s = appData.students.find(x => x.id === currentJustificationStudentId);
                const d = ensureSubjectData(s, appData.currentSubject);
                d.attendance[currentJustificationDate] = { 
                    status: 'F', 
                    justified: false, 
                    pendingReview: true, 
                    reason: reason, 
                    doc: b64 
                };
                getCollection('concenal_students').doc(s.id).set({subjects:{[appData.currentSubject]:{attendance:d.attendance}}},{merge:true});
                closeModal('modal-justification');
                alert("Justificativa enviada para coordenação.");
                renderAttendanceTable();
            };

            if (f) {
                const r = new FileReader(); r.readAsDataURL(f);
                r.onload = e => {
                    const i = new Image(); i.src = e.target.result;
                    i.onload = () => {
                        const c = document.createElement('canvas'); 
                        const scale = 500 / Math.max(i.width, i.height);
                        c.width = i.width * scale; c.height = i.height * scale;
                        c.getContext('2d').drawImage(i, 0, 0, c.width, c.height);
                        save(c.toDataURL('image/jpeg', 0.6));
                    };
                };
            } else { save(null); }
        }

        // --- GESTÃO USUÁRIOS E ASSIGNMENTS ---
        function switchUserTab(t){ 
            creatingUserType=t; 
            document.getElementById('tab-teacher').className=t==='teacher'?"flex-1 py-2 font-bold text-[10px] uppercase rounded-md transition bg-white shadow-sm text-gray-800":"flex-1 py-2 font-bold text-[10px] uppercase rounded-md transition text-gray-400";
            document.getElementById('tab-parent').className=t==='parent'?"flex-1 py-2 font-bold text-[10px] uppercase rounded-md transition bg-white shadow-sm text-gray-800":"flex-1 py-2 font-bold text-[10px] uppercase rounded-md transition text-gray-400";
            document.getElementById('field-teacher-subj').classList.toggle('hidden', t!=='teacher');
            document.getElementById('field-parent-student').classList.toggle('hidden', t!=='parent');
            
            if(t === 'teacher') renderAssignmentsUI();
            loadUsersList();
        }

        function toggleSubjClasses(checkbox, safeSubj) {
            const div = document.getElementById(`classes-for-${safeSubj}`);
            if (checkbox.checked) {
                div.classList.remove('hidden');
            } else {
                div.classList.add('hidden');
                div.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = false);
            }
        }

        function renderAssignmentsUI(existingAssignments = {}) {
            const container = document.getElementById('assignments-container');
            if(!container) return;
            container.innerHTML = appData.allSubjects.map(subj => {
                const safeSubj = subj.replace(/[^a-zA-Z0-9]/g, '');
                const isChecked = existingAssignments[subj] ? 'checked' : '';
                const classes = existingAssignments[subj] || [];
                const classCheckboxes = appData.allClasses.map(c => `
                    <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" value="${c}" class="cls-cb-${safeSubj}" ${classes.includes(c) ? 'checked' : ''}> ${c}</label>
                `).join('');
                
                return `
                    <div class="border border-gray-100 rounded-lg p-3 bg-gray-50 mb-2 shadow-sm transition hover:border-green-200">
                        <label class="font-bold text-sm text-school-green flex items-center gap-2 cursor-pointer w-full">
                            <input type="checkbox" class="subj-main-cb w-4 h-4 text-school-green" value="${subj}" onchange="toggleSubjClasses(this, '${safeSubj}')" ${isChecked}> ${subj}
                        </label>
                        <div id="classes-for-${safeSubj}" class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-[10px] mt-3 pl-4 border-l-2 border-green-200 ${isChecked ? '' : 'hidden'}">
                            ${classCheckboxes}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function saveUserOps() {
            const id = document.getElementById('edit-user-id').value;
            const n = document.getElementById('new-u-name').value;
            const d = document.getElementById('new-u-display').value;
            const l = document.getElementById('new-u-login').value;
            const p = document.getElementById('new-u-pass').value;
            const r = document.getElementById('new-u-role').value;

            let data = { name: n, displayName: d, username: l.toLowerCase(), role: creatingUserType === 'parent' ? 'parent' : r };
            if(p) data.password = p;

            if(creatingUserType === 'teacher'){
                let assignments = {};
                document.querySelectorAll('.subj-main-cb:checked').forEach(cb => {
                    const subj = cb.value;
                    const safeSubj = subj.replace(/[^a-zA-Z0-9]/g, '');
                    const clsChecked = Array.from(document.querySelectorAll(`.cls-cb-${safeSubj}:checked`)).map(c=>c.value);
                    assignments[subj] = clsChecked;
                });
                
                data.assignments = assignments;
                data.subjects = Object.keys(assignments);
                
                let uniqueClasses = new Set();
                Object.values(assignments).forEach(clist => clist.forEach(c => uniqueClasses.add(c)));
                data.classes = Array.from(uniqueClasses);
            } else { 
                data.studentId = document.getElementById('new-u-student-id').value; 
            }

            if(!n || !l) return alert("Preencha os campos obrigatórios.");

            try {
                if(id) { 
                    try {
                        await getCollection('concenal_users').doc(id).update(data);
                    } catch(err) {
                        await getCollection('concenal_users').doc(id).set(data);
                    }
                } 
                else { 
                    if(!p) return alert("Defina uma senha"); 
                    await getCollection('concenal_users').add(data); 
                }
                alert("Operação concluída!"); loadUsersList(); cancelEdit();
            } catch(e) { alert(e.message); }
        }

        function editUser(id, dataStr) {
            const data = JSON.parse(decodeURIComponent(dataStr));
            document.getElementById('edit-user-id').value = id;
            document.getElementById('new-u-name').value = data.name;
            document.getElementById('new-u-display').value = data.displayName || '';
            document.getElementById('new-u-login').value = data.username;
            document.getElementById('new-u-pass').value = '';
            document.getElementById('new-u-role').value = data.role || 'teacher';
            
            let assignments = data.assignments || {};
            if (Object.keys(assignments).length === 0 && data.subjects && data.classes) {
                data.subjects.forEach(s => assignments[s] = data.classes);
            }
            
            renderAssignmentsUI(assignments);

            if(data.studentId) document.getElementById('new-u-student-id').value = data.studentId;
            document.getElementById('btn-save-user').innerText = "Atualizar Cadastro";
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
        }

        function cancelEdit() {
            document.getElementById('edit-user-id').value = '';
            document.querySelectorAll('#modal-users input[type=text], #modal-users input[type=password]').forEach(i=>i.value='');
            renderAssignmentsUI({});
            document.getElementById('btn-save-user').innerText = "Salvar Cadastro";
            document.getElementById('btn-cancel-edit').classList.add('hidden');
        }

        function loadUsersList() {
            const list = document.getElementById('users-list'); list.innerHTML = '<div class="p-8 text-center"><i class="fas fa-circle-notch fa-spin"></i></div>';
            
            getCollection('concenal_users').get().then(snap => {
                list.innerHTML = '';
                snap.forEach(doc => {
                    const u = doc.data();
                    
                    if (creatingUserType === 'parent' && u.role !== 'parent') return;
                    if (creatingUserType === 'teacher' && u.role === 'parent') return;

                    const dataStr = encodeURIComponent(JSON.stringify(u));
                    list.innerHTML += `
                        <div class="flex justify-between items-center p-3 border bg-white rounded-xl shadow-sm border-gray-100">
                            <div class="leading-tight">
                                <b class="text-[9px] text-school-green uppercase">${u.role}</b><br>
                                <span class="text-sm font-bold text-gray-700">${u.displayName || u.name}</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editUser('${doc.id}', '${dataStr}')" class="w-8 h-8 bg-blue-50 text-blue-500 rounded-lg flex items-center justify-center"><i class="fas fa-edit"></i></button>
                                <button onclick="deleteLogin('${doc.id}')" class="w-8 h-8 bg-red-50 text-red-500 rounded-lg flex items-center justify-center"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`;
                });
            });
        }

        function deleteLogin(id) {
            if(confirm("Deseja apagar este acesso?")) {
                getCollection('concenal_users').doc(id).delete().then(() => { loadUsersList(); }).catch(e => alert(e.message));
            }
        }

        // --- START ---
        document.addEventListener('DOMContentLoaded', initFirebase);
    </script>
</body>
</html>
